name: Ierahkwa Platform — Build, Test & Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/ierahkwa

jobs:

  # ==================== BUILD GATEWAY ====================
  build-gateway:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - name: Restore & Build Gateway
        run: dotnet build 08-dotnet/gateway/Ierahkwa.Gateway -c Release
      - name: Build Docker Image
        run: docker build -t ${{ env.IMAGE_PREFIX }}-gateway:${{ github.sha }} 08-dotnet/gateway/Ierahkwa.Gateway

  # ==================== BUILD ALL MICROSERVICES ====================
  build-microservices:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          # NEXUS Orbital
          - SpaceService
          - TelecomService
          - GenomicsService
          - IoTRoboticsService
          - QuantumService
          - AIEngineService
          - NetworkService
          - DevToolsService
          # NEXUS Escudo
          - MilitaryService
          - DroneService
          - CyberSecService
          - IntelligenceService
          - EmergencyService
          # NEXUS Cerebro
          - EducationService
          - ResearchService
          - LanguageService
          - SearchService
          # NEXUS Tesoro
          - CommerceService
          - BlockchainService
          - BankingService
          - InsuranceService
          - EmploymentService
          - SmartFactoryService
          - ArtisanService
          - TourismService
          # NEXUS Voces
          - MediaContentService
          - MessagingService
          - CultureArchiveService
          - SportsService
          - SocialService
          # NEXUS Consejo
          - GovernanceService
          - JusticeService
          - DiplomacyService
          - CitizenService
          - SocialWelfareService
          # NEXUS Tierra
          - AgricultureService
          - NaturalResourceService
          - EnvironmentService
          - WasteService
          - EnergyService
          # NEXUS Forja
          - DevOpsService
          - LowCodeDesignService
          - BrowserService
          - ProductivityService
          - CloudService
          # NEXUS Urbe
          - UrbanService
          - TransportService
          - PostalMapsService
          - HousingService
          # NEXUS Raíces
          - IdentityService
          - HealthService
          - NexusAggregationService
          - LicensingService
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - name: Build ${{ matrix.service }}
        run: dotnet build 08-dotnet/microservices/${{ matrix.service }} -c Release

  # ==================== INTEGRATION TESTS ====================
  integration-tests:
    runs-on: ubuntu-latest
    needs: [build-gateway, build-microservices]
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: Ierahkwa2026!
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P Ierahkwa2026! -Q 'SELECT 1' -C -No"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - name: Run Database Migrations
        run: dotnet run --project 08-dotnet/migrations/Ierahkwa.Migrations -- "Server=localhost;Database=IerahkwaDb;User=sa;Password=Ierahkwa2026!;TrustServerCertificate=true"
      - name: Run Integration Tests
        run: dotnet test e2e/Ierahkwa.IntegrationTests -c Release --logger "console;verbosity=detailed"

  # ==================== DOCKER BUILD & PUSH ====================
  docker-push:
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.ref == 'refs/heads/main'
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & Push Gateway
        run: |
          docker build -t ${{ env.IMAGE_PREFIX }}-gateway:latest -t ${{ env.IMAGE_PREFIX }}-gateway:${{ github.sha }} 08-dotnet/gateway/Ierahkwa.Gateway
          docker push ${{ env.IMAGE_PREFIX }}-gateway:latest
          docker push ${{ env.IMAGE_PREFIX }}-gateway:${{ github.sha }}

  # ==================== DEPLOY TO KUBERNETES ====================
  deploy:
    runs-on: ubuntu-latest
    needs: [docker-push]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/namespace.yml
          kubectl apply -f k8s/secrets.yml
          kubectl apply -f k8s/services/
          kubectl set image deployment/gateway gateway=${{ env.IMAGE_PREFIX }}-gateway:${{ github.sha }} -n ierahkwa
          kubectl rollout status deployment/gateway -n ierahkwa --timeout=120s
      - name: Verify Deployment
        run: |
          kubectl get pods -n ierahkwa
          kubectl get services -n ierahkwa
