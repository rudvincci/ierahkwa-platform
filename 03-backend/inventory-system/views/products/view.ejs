<%- include('../partials/header') %>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-box"></i> <%= product.name %></h2>
        <div>
            <a href="/products/<%= product.id %>/edit" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a href="/products" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">Product Details</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th class="text-muted" width="40%">Code:</th>
                                    <td><strong><%= product.code %></strong></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Barcode:</th>
                                    <td><%= product.barcode || '-' %></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Category:</th>
                                    <td><%= product.category_name || '-' %></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Supplier:</th>
                                    <td><%= product.supplier_name || '-' %></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Location:</th>
                                    <td><%= product.location || '-' %></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th class="text-muted" width="50%">Purchase Price:</th>
                                    <td><strong>$<%= product.purchase_price.toFixed(2) %></strong></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Sale Price:</th>
                                    <td><strong class="text-success">$<%= product.sale_price.toFixed(2) %></strong></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Profit Margin:</th>
                                    <td><%= product.sale_price > 0 ? (((product.sale_price - product.purchase_price) / product.sale_price) * 100).toFixed(1) : 0 %>%</td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Unit:</th>
                                    <td><%= product.unit %></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Status:</th>
                                    <td>
                                        <% if (!product.is_active) { %>
                                        <span class="badge bg-secondary">Inactive</span>
                                        <% } else if (product.current_stock <= product.min_stock) { %>
                                        <span class="badge bg-danger">Low Stock</span>
                                        <% } else { %>
                                        <span class="badge bg-success">Active</span>
                                        <% } %>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <% if (product.description) { %>
                    <hr>
                    <h6>Description</h6>
                    <p><%= product.description %></p>
                    <% } %>
                    <% if (product.notes) { %>
                    <hr>
                    <h6>Notes</h6>
                    <p><%= product.notes %></p>
                    <% } %>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> Movement History
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th class="text-end">Qty</th>
                                    <th class="text-end">Before</th>
                                    <th class="text-end">After</th>
                                    <th class="text-end">Price</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% movements.forEach(m => { %>
                                <tr>
                                    <td><%= new Date(m.created_at).toLocaleString() %></td>
                                    <td>
                                        <span class="badge bg-<%= m.type === 'purchase' || m.type === 'return' ? 'success' : m.type === 'sale' || m.type === 'damage' ? 'danger' : 'warning' %>">
                                            <%= m.type %>
                                        </span>
                                    </td>
                                    <td class="text-end"><%= m.quantity %></td>
                                    <td class="text-end"><%= m.previous_stock %></td>
                                    <td class="text-end"><%= m.new_stock %></td>
                                    <td class="text-end">$<%= m.unit_price.toFixed(2) %></td>
                                    <td><%= m.user_name %></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4 bg-light">
                <div class="card-body text-center">
                    <h3 class="display-1 <%= product.current_stock <= product.min_stock ? 'text-danger' : 'text-primary' %>">
                        <%= product.current_stock %>
                    </h3>
                    <p class="text-muted mb-0">Current Stock</p>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h5><%= product.min_stock %></h5>
                            <small class="text-muted">Minimum</small>
                        </div>
                        <div class="col-6">
                            <h5><%= product.max_stock %></h5>
                            <small class="text-muted">Maximum</small>
                        </div>
                    </div>
                    <hr>
                    <h4 class="text-success">$<%= (product.current_stock * product.purchase_price).toFixed(2) %></h4>
                    <small class="text-muted">Stock Value</small>
                </div>
            </div>

            <% if (product.image) { %>
            <div class="card mb-4">
                <img src="<%= product.image %>" class="card-img-top" alt="<%= product.name %>">
            </div>
            <% } %>

            <div class="card">
                <div class="card-header">Quick Actions</div>
                <div class="card-body d-grid gap-2">
                    <a href="/movements/stock-in?product=<%= product.id %>" class="btn btn-success">
                        <i class="bi bi-box-arrow-in-down"></i> Stock In
                    </a>
                    <a href="/movements/stock-out?product=<%= product.id %>" class="btn btn-danger">
                        <i class="bi bi-box-arrow-up"></i> Stock Out
                    </a>
                    <a href="/movements?product_id=<%= product.id %>" class="btn btn-outline-secondary">
                        <i class="bi bi-clock-history"></i> Full History
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>
