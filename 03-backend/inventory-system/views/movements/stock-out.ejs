<%- include('../partials/header') %>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-box-arrow-up text-danger"></i> Stock Out - Sale</h2>
        <a href="/movements" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Movements
        </a>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header bg-danger text-white">Add Item</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Document Number</label>
                        <input type="text" id="documentNumber" class="form-control" value="<%= documentNumber %>" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Search Product</label>
                        <input type="text" id="productSearch" class="form-control" placeholder="Type code, barcode or name..." autofocus>
                        <div id="searchResults" class="list-group position-absolute" style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    <div id="selectedProduct" style="display: none;">
                        <div class="alert alert-warning">
                            <strong id="productName"></strong>
                            <small class="d-block">Code: <span id="productCode"></span></small>
                            <small class="d-block">Available Stock: <strong id="currentStock" class="text-primary"></strong></small>
                        </div>
                        <input type="hidden" id="productId">
                        <input type="hidden" id="maxStock">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Quantity *</label>
                                <input type="number" id="quantity" class="form-control" value="1" min="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Unit Price *</label>
                                <input type="number" id="unitPrice" class="form-control" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" id="addItem" class="btn btn-danger w-100">
                                <i class="bi bi-plus-circle"></i> Add to List
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Reference</label>
                        <input type="text" id="reference" class="form-control" placeholder="Invoice, Order #, etc.">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Items List</span>
                    <span class="badge bg-danger" id="itemCount">0 items</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="itemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th class="text-end">Qty</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="3" class="text-end">Grand Total:</th>
                                    <th class="text-end" id="grandTotal">$0.00</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex gap-2">
                        <button type="button" id="clearAll" class="btn btn-outline-secondary">
                            <i class="bi bi-trash"></i> Clear All
                        </button>
                        <button type="button" id="saveMovement" class="btn btn-danger flex-grow-1">
                            <i class="bi bi-check-circle"></i> Save Stock Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const products = <%- products %>;
let items = [];

$('#productSearch').on('input', function() {
    const term = $(this).val().toLowerCase();
    if (term.length < 1) {
        $('#searchResults').hide();
        return;
    }
    
    const matches = products.filter(p => 
        p.current_stock > 0 && (
            p.code.toLowerCase().includes(term) || 
            (p.barcode && p.barcode.toLowerCase().includes(term)) ||
            p.name.toLowerCase().includes(term)
        )
    ).slice(0, 10);
    
    let html = '';
    matches.forEach(p => {
        html += `<a href="#" class="list-group-item list-group-item-action" data-id="${p.id}">
            <strong>${p.code}</strong> - ${p.name}
            <small class="text-success float-end">Stock: ${p.current_stock}</small>
        </a>`;
    });
    $('#searchResults').html(html).show();
});

$('#searchResults').on('click', 'a', function(e) {
    e.preventDefault();
    const id = $(this).data('id');
    const product = products.find(p => p.id === id);
    
    if (product) {
        $('#productId').val(product.id);
        $('#maxStock').val(product.current_stock);
        $('#productName').text(product.name);
        $('#productCode').text(product.code);
        $('#currentStock').text(product.current_stock);
        $('#unitPrice').val(product.sale_price.toFixed(2));
        $('#quantity').val(1).attr('max', product.current_stock);
        $('#selectedProduct').show();
        $('#productSearch').val('');
        $('#searchResults').hide();
        $('#quantity').focus();
    }
});

$('#addItem').click(function() {
    const productId = parseInt($('#productId').val());
    const product = products.find(p => p.id === productId);
    const quantity = parseInt($('#quantity').val());
    const unitPrice = parseFloat($('#unitPrice').val());
    const maxStock = parseInt($('#maxStock').val());
    
    // Calculate already added quantity
    const existingItem = items.find(i => i.product_id === productId);
    const alreadyAdded = existingItem ? existingItem.quantity : 0;
    
    if (quantity + alreadyAdded > maxStock) {
        alert(`Cannot exceed available stock (${maxStock}). Already added: ${alreadyAdded}`);
        return;
    }
    
    if (existingItem) {
        existingItem.quantity += quantity;
        existingItem.total = existingItem.quantity * existingItem.unit_price;
    } else {
        items.push({
            product_id: productId,
            code: product.code,
            name: product.name,
            quantity: quantity,
            unit_price: unitPrice,
            total: quantity * unitPrice
        });
    }
    
    renderItems();
    $('#selectedProduct').hide();
    $('#productSearch').focus();
});

function renderItems() {
    let html = '';
    let grandTotal = 0;
    
    items.forEach((item, index) => {
        html += `<tr>
            <td>${item.name}<br><small class="text-muted">${item.code}</small></td>
            <td class="text-end">${item.quantity}</td>
            <td class="text-end">$${item.unit_price.toFixed(2)}</td>
            <td class="text-end">$${item.total.toFixed(2)}</td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})"><i class="bi bi-x"></i></button></td>
        </tr>`;
        grandTotal += item.total;
    });
    
    $('#itemsTable tbody').html(html);
    $('#grandTotal').text('$' + grandTotal.toFixed(2));
    $('#itemCount').text(items.length + ' items');
}

function removeItem(index) {
    items.splice(index, 1);
    renderItems();
}

$('#clearAll').click(function() {
    if (confirm('Clear all items?')) {
        items = [];
        renderItems();
    }
});

$('#saveMovement').click(function() {
    if (items.length === 0) {
        alert('Please add items to the list');
        return;
    }
    
    if (!confirm('Save ' + items.length + ' items?')) return;
    
    $(this).prop('disabled', true).html('<i class="bi bi-hourglass"></i> Saving...');
    
    $.post('/movements/process', {
        type: 'sale',
        document_number: $('#documentNumber').val(),
        reference: $('#reference').val(),
        items: JSON.stringify(items)
    }).done(function(response) {
        if (response.success) {
            alert(response.message);
            window.location.href = '/movements';
        } else {
            alert('Error: ' + response.message);
            $('#saveMovement').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Save Stock Out');
        }
    });
});

$('#quantity, #unitPrice').keypress(function(e) {
    if (e.which === 13) $('#addItem').click();
});
</script>

<%- include('../partials/footer') %>
