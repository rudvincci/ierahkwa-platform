<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monetary System M0-M4 | Ierahkwa Sovereign Blockchain</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --m0: #22d3ee; --m1: #f59e0b; --m2: #10b981; --m3: #8b5cf6; --m4: #ec4899;
      --bg-dark: #0f172a; --bg-card: #1e293b; --bg-input: #334155;
      --border: #475569; --text: #f1f5f9; --text-muted: #94a3b8;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
    .navbar { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid var(--border); }
    .navbar-brand { font-weight: 700; background: linear-gradient(135deg, var(--m0), var(--m1), var(--m2), var(--m3), var(--m4)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-link { color: var(--text-muted) !important; }
    .nav-link:hover, .nav-link.active { color: var(--m0) !important; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; }
    .card-header { background: transparent; border-bottom: 1px solid var(--border); }
    .form-control, .form-select { background: var(--bg-input); border-color: var(--border); color: var(--text); }
    .form-control:focus, .form-select:focus { background: var(--bg-input); border-color: var(--m0); color: var(--text); box-shadow: 0 0 0 2px rgba(34,211,238,0.25); }
    .table { color: var(--text); }
    .table th { color: var(--text-muted); border-color: var(--border); font-weight: 500; font-size: 0.75rem; text-transform: uppercase; }
    .table td { border-color: rgba(255,255,255,0.05); vertical-align: middle; }
    
    /* M-Class Cards */
    .mclass-card { border-radius: 16px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
    .mclass-card:hover { transform: translateY(-4px); }
    .mclass-card.selected { border-color: white; box-shadow: 0 0 30px rgba(255,255,255,0.2); }
    .mclass-card.m0 { background: linear-gradient(135deg, rgba(34,211,238,0.2) 0%, rgba(34,211,238,0.05) 100%); border-color: var(--m0); }
    .mclass-card.m1 { background: linear-gradient(135deg, rgba(245,158,11,0.2) 0%, rgba(245,158,11,0.05) 100%); border-color: var(--m1); }
    .mclass-card.m2 { background: linear-gradient(135deg, rgba(16,185,129,0.2) 0%, rgba(16,185,129,0.05) 100%); border-color: var(--m2); }
    .mclass-card.m3 { background: linear-gradient(135deg, rgba(139,92,246,0.2) 0%, rgba(139,92,246,0.05) 100%); border-color: var(--m3); }
    .mclass-card.m4 { background: linear-gradient(135deg, rgba(236,72,153,0.2) 0%, rgba(236,72,153,0.05) 100%); border-color: var(--m4); }
    .mclass-card h3 { font-size: 2.5rem; font-weight: 800; margin: 0; }
    .mclass-card.m0 h3 { color: var(--m0); }
    .mclass-card.m1 h3 { color: var(--m1); }
    .mclass-card.m2 h3 { color: var(--m2); }
    .mclass-card.m3 h3 { color: var(--m3); }
    .mclass-card.m4 h3 { color: var(--m4); }
    
    .stat-card { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border); }
    .stat-card .stat-value { font-size: 1.5rem; font-weight: 700; }
    .stat-card .stat-label { color: var(--text-muted); font-size: 0.8rem; }
    
    .humanitarian-card { background: linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(34,211,238,0.1) 100%); border: 1px solid var(--success); border-radius: 16px; padding: 1.5rem; }
    .humanitarian-card h5 { color: var(--success); }
    
    .asset-tag { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; margin: 0.25rem; cursor: pointer; transition: all 0.2s; }
    .asset-tag:hover { transform: scale(1.05); }
    .asset-tag.m1 { background: rgba(245,158,11,0.2); color: var(--m1); border: 1px solid var(--m1); }
    .asset-tag.m2 { background: rgba(16,185,129,0.2); color: var(--m2); border: 1px solid var(--m2); }
    .asset-tag.m3 { background: rgba(139,92,246,0.2); color: var(--m3); border: 1px solid var(--m3); }
    .asset-tag.m4 { background: rgba(236,72,153,0.2); color: var(--m4); border: 1px solid var(--m4); }
    
    .progress { height: 8px; background: var(--bg-input); border-radius: 4px; }
    .progress-bar { border-radius: 4px; }
    
    .conversion-preview { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.25rem; margin-top: 1rem; }
    .conversion-preview .arrow { font-size: 2rem; color: var(--m0); }
    
    .btn-m0 { background: var(--m0); border-color: var(--m0); color: #000; }
    .btn-m1 { background: var(--m1); border-color: var(--m1); color: #000; }
    .btn-m2 { background: var(--m2); border-color: var(--m2); color: #fff; }
    .btn-m3 { background: var(--m3); border-color: var(--m3); color: #fff; }
    .btn-m4 { background: var(--m4); border-color: var(--m4); color: #fff; }
    
    .modal-content { background: var(--bg-card); border: 1px solid var(--border); }
    .modal-header, .modal-footer { border-color: var(--border); }
    .btn-close { filter: invert(1); }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="/monetary">
        <i class="bi bi-bank2 me-2"></i>Monetary System M0-M4
      </a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link active" href="#" onclick="showSection('receive')"><i class="bi bi-box-arrow-in-down me-1"></i>Receive Funds</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('holdings')"><i class="bi bi-safe me-1"></i>Holdings</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('convert')"><i class="bi bi-arrow-repeat me-1"></i>Convert</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('humanitarian')"><i class="bi bi-heart me-1"></i>Humanitarian</a></li>
        </ul>
        <div class="d-flex gap-2">
          <a href="/trading" class="btn btn-outline-primary btn-sm"><i class="bi bi-graph-up"></i> Trading</a>
          <a href="/" class="btn btn-outline-light btn-sm"><i class="bi bi-shop"></i></a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-4 py-4">
    <!-- Receive Funds Section -->
    <section id="section-receive" class="section">
      <div class="mb-4">
        <h4><i class="bi bi-box-arrow-in-down me-2"></i>1. RECEIVE FUNDS (M0-M4)</h4>
        <p class="text-muted">Select a monetary classification to receive funds. Each class has different assets and conversion rates.</p>
      </div>

      <!-- M-Class Selection -->
      <div class="row g-3 mb-4">
        <div class="col">
          <div class="mclass-card m0" onclick="selectMClass('M0')">
            <h3>M0</h3>
            <div class="small">Monetary Base</div>
            <div class="text-muted small">(Currency + Reserves)</div>
          </div>
        </div>
        <div class="col">
          <div class="mclass-card m1" onclick="selectMClass('M1')">
            <h3>M1</h3>
            <div class="small">M0 +</div>
            <div class="text-muted small">Demand Deposits</div>
          </div>
        </div>
        <div class="col">
          <div class="mclass-card m2" onclick="selectMClass('M2')">
            <h3>M2</h3>
            <div class="small">M1 + Savings</div>
            <div class="text-muted small">Term Deposits</div>
          </div>
        </div>
        <div class="col">
          <div class="mclass-card m3" onclick="selectMClass('M3')">
            <h3>M3</h3>
            <div class="small">M2 + Large</div>
            <div class="text-muted small">Deposits</div>
          </div>
        </div>
        <div class="col">
          <div class="mclass-card m4" onclick="selectMClass('M4')">
            <h3>M4</h3>
            <div class="small">M3 + Commercial</div>
            <div class="text-muted small">Paper + Bonds</div>
          </div>
        </div>
      </div>

      <!-- Amount Input -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-cash-stack me-2"></i>AMOUNT TO RECEIVE (USD):</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Entity Type</label>
              <select class="form-select" id="receiveEntityType" onchange="loadReceiveEntities()">
                <option value="central_bank">Central Bank</option>
                <option value="futurehead">Futurehead</option>
                <option value="government">Government</option>
                <option value="department">Department</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Entity</label>
              <select class="form-select" id="receiveEntity"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Selected Classification</label>
              <input type="text" class="form-control" id="selectedMClassDisplay" readonly value="Select M-Class above">
            </div>
          </div>
          
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Amount (USD)</label>
              <input type="number" class="form-control form-control-lg" id="receiveAmount" placeholder="Enter amount" oninput="calculateConversion()">
            </div>
            <div class="col-md-6">
              <label class="form-label">Assets (Optional)</label>
              <div id="assetSelection" class="border rounded p-2" style="min-height:48px;background:var(--bg-input)"></div>
            </div>
          </div>

          <!-- Conversion Preview -->
          <div class="conversion-preview" id="conversionPreview" style="display:none">
            <div class="row align-items-center">
              <div class="col-md-4 text-center">
                <div class="text-muted small">ORIGINAL VALUE</div>
                <div class="h4 mb-0" id="previewOriginal">$0</div>
              </div>
              <div class="col-md-1 text-center">
                <div class="arrow"><i class="bi bi-arrow-right"></i></div>
              </div>
              <div class="col-md-3 text-center">
                <div class="text-muted small">CONVERSION RATE</div>
                <div class="h5 mb-0" id="previewRate">100%</div>
              </div>
              <div class="col-md-4 text-center">
                <div class="text-muted small">NET TO RECEIVE</div>
                <div class="h4 mb-0 text-success" id="previewNet">$0</div>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-md-6">
                <div class="d-flex justify-content-between">
                  <span><i class="bi bi-heart text-danger me-1"></i>Humanitarian Contribution:</span>
                  <span id="previewHumanitarian" class="text-warning">$0 (0%)</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex justify-content-between">
                  <span><i class="bi bi-coin text-info me-1"></i>IGT Tokens to Receive:</span>
                  <span id="previewIGT" class="text-info">0 IGT</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <button class="btn btn-lg btn-success" onclick="receiveFunds()">
              <i class="bi bi-check-circle me-2"></i>Receive Funds
            </button>
            <button class="btn btn-lg btn-outline-info ms-2" onclick="receiveFunds(true)">
              <i class="bi bi-coin me-2"></i>Receive & Convert to IGT
            </button>
          </div>
        </div>
      </div>

      <!-- Asset Types Reference -->
      <div class="card">
        <div class="card-header"><h6 class="mb-0">Asset Types by Classification</h6></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <h6 style="color:var(--m1)"><i class="bi bi-gem me-1"></i>M1 - Precious Assets</h6>
              <div id="m1Assets"></div>
            </div>
            <div class="col-md-3">
              <h6 style="color:var(--m2)"><i class="bi bi-house me-1"></i>M2 - Real Assets</h6>
              <div id="m2Assets"></div>
            </div>
            <div class="col-md-3">
              <h6 style="color:var(--m3)"><i class="bi bi-bank me-1"></i>M3 - Large Deposits</h6>
              <div id="m3Assets"></div>
            </div>
            <div class="col-md-3">
              <h6 style="color:var(--m4)"><i class="bi bi-file-earmark-text me-1"></i>M4 - Paper + Bonds</h6>
              <div id="m4Assets"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Holdings Section -->
    <section id="section-holdings" class="section d-none">
      <h4 class="mb-4"><i class="bi bi-safe me-2"></i>Asset Holdings</h4>
      
      <div class="row g-3 mb-4" id="holdingsStats"></div>
      
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">All Holdings</h5>
          <select class="form-select w-auto" id="holdingsFilter" onchange="loadHoldings()">
            <option value="">All Classes</option>
            <option value="M0">M0</option>
            <option value="M1">M1</option>
            <option value="M2">M2</option>
            <option value="M3">M3</option>
            <option value="M4">M4</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr><th>Entity</th><th>Class</th><th>Asset</th><th>Quantity</th><th>Value (USD)</th><th>Certificate</th><th>Status</th></tr>
              </thead>
              <tbody id="holdingsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Convert Section -->
    <section id="section-convert" class="section d-none">
      <h4 class="mb-4"><i class="bi bi-arrow-repeat me-2"></i>Convert Assets to M0 (IGT)</h4>
      
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Select Holdings to Convert</h5></div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Entity Type</label>
                <select class="form-select" id="convertEntityType" onchange="loadConvertEntities()">
                  <option value="central_bank">Central Bank</option>
                  <option value="futurehead">Futurehead</option>
                  <option value="government">Government</option>
                  <option value="department">Department</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Entity</label>
                <select class="form-select" id="convertEntity" onchange="loadEntityHoldings()"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Available Holdings</label>
                <div id="convertHoldingsList" class="border rounded p-2" style="max-height:300px;overflow-y:auto;background:var(--bg-input)"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Conversion Summary</h5></div>
            <div class="card-body">
              <div id="convertSummary">
                <p class="text-muted">Select holdings to see conversion summary</p>
              </div>
              <button class="btn btn-success w-100 mt-3" onclick="executeConversion()">
                <i class="bi bi-check-circle me-2"></i>Execute Conversion
              </button>
            </div>
          </div>
          
          <div class="card mt-3">
            <div class="card-header"><h6 class="mb-0">Conversion Rates & Humanitarian %</h6></div>
            <div class="card-body" id="conversionRatesInfo"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Humanitarian Section -->
    <section id="section-humanitarian" class="section d-none">
      <h4 class="mb-4"><i class="bi bi-heart me-2"></i>Humanitarian Fund</h4>
      
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="humanitarian-card">
            <h5><i class="bi bi-piggy-bank me-2"></i>Total Collected</h5>
            <div class="h2 mb-0" id="humCollected">$0</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="humanitarian-card">
            <h5><i class="bi bi-send me-2"></i>Total Distributed</h5>
            <div class="h2 mb-0" id="humDistributed">$0</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="humanitarian-card">
            <h5><i class="bi bi-wallet2 me-2"></i>Available Balance</h5>
            <div class="h2 mb-0" id="humBalance">$0</div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Fund Allocations by Purpose</h5></div>
            <div class="card-body" id="humAllocations"></div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Recent Transactions</h5></div>
            <div class="card-body p-0">
              <div class="table-responsive" style="max-height:400px;overflow-y:auto">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Date</th><th>Type</th><th>Amount</th></tr></thead>
                  <tbody id="humTransactions"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let classifications = {};
    let humanitarianConfig = {};
    let allEntities = [];
    let selectedMClass = null;
    let selectedHoldings = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadClassifications();
      loadAllEntities();
      loadDashboard();
    });

    function showSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
      document.getElementById('section-' + name).classList.remove('d-none');
      document.querySelectorAll('.navbar-nav .nav-link').forEach(l => l.classList.remove('active'));
      event.target.classList.add('active');
      
      if (name === 'holdings') loadHoldings();
      if (name === 'humanitarian') loadHumanitarian();
    }

    async function api(url, method = 'GET', data = null) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (data) opts.body = JSON.stringify(data);
      const res = await fetch(url, opts);
      return res.json();
    }

    function formatNumber(n, decimals = 2) {
      if (n >= 1e12) return '$' + (n / 1e12).toFixed(decimals) + 'T';
      if (n >= 1e9) return '$' + (n / 1e9).toFixed(decimals) + 'B';
      if (n >= 1e6) return '$' + (n / 1e6).toFixed(decimals) + 'M';
      if (n >= 1e3) return '$' + (n / 1e3).toFixed(decimals) + 'K';
      return '$' + n.toFixed(decimals);
    }

    async function loadClassifications() {
      const data = await api('/api/monetary/classifications');
      classifications = data.classifications || {};
      humanitarianConfig = data.humanitarian_config || {};
      
      // Render asset types
      ['M1', 'M2', 'M3', 'M4'].forEach(mc => {
        const cls = classifications[mc];
        if (cls && cls.assets) {
          document.getElementById(`${mc.toLowerCase()}Assets`).innerHTML = cls.assets.map(a => 
            `<span class="asset-tag ${mc.toLowerCase()}">${a.name}</span>`
          ).join('');
        }
      });
      
      // Render conversion rates
      document.getElementById('conversionRatesInfo').innerHTML = Object.entries(classifications).map(([code, c]) => `
        <div class="d-flex justify-content-between mb-2">
          <span style="color:${c.color}">${code} - ${c.name}</span>
          <span>
            <span class="badge" style="background:${c.color};color:#000">${(c.conversion_rate * 100).toFixed(0)}%</span>
            <span class="badge bg-danger">${c.humanitarian_percent}% Humanitarian</span>
          </span>
        </div>
      `).join('');
    }

    async function loadAllEntities() {
      allEntities = await api('/api/banking/all-entities');
      loadReceiveEntities();
      loadConvertEntities();
    }

    function loadReceiveEntities() {
      const type = document.getElementById('receiveEntityType').value;
      const entities = allEntities.filter(e => e.entity_type === type);
      document.getElementById('receiveEntity').innerHTML = entities.map(e => 
        `<option value="${e.id}">${e.display_name || e.name} (${e.code || e.token_symbol || ''})</option>`
      ).join('');
    }

    function loadConvertEntities() {
      const type = document.getElementById('convertEntityType').value;
      const entities = allEntities.filter(e => e.entity_type === type);
      document.getElementById('convertEntity').innerHTML = entities.map(e => 
        `<option value="${e.id}">${e.display_name || e.name}</option>`
      ).join('');
    }

    function selectMClass(mclass) {
      selectedMClass = mclass;
      document.querySelectorAll('.mclass-card').forEach(c => c.classList.remove('selected'));
      document.querySelector(`.mclass-card.${mclass.toLowerCase()}`).classList.add('selected');
      
      const cls = classifications[mclass];
      document.getElementById('selectedMClassDisplay').value = `${mclass} - ${cls?.name || ''}`;
      
      // Show asset selection for M1-M4
      if (mclass !== 'M0' && cls?.assets) {
        document.getElementById('assetSelection').innerHTML = cls.assets.map(a => `
          <span class="asset-tag ${mclass.toLowerCase()}" onclick="toggleAsset('${a.type}')" data-asset="${a.type}">
            ${a.name} (${a.price_per_unit ? '$' + a.price_per_unit + '/' + a.unit : a.unit})
          </span>
        `).join('');
      } else {
        document.getElementById('assetSelection').innerHTML = '<span class="text-muted">M0 - Cash/Fiat (no specific assets)</span>';
      }
      
      calculateConversion();
    }

    function toggleAsset(assetType) {
      const tag = document.querySelector(`[data-asset="${assetType}"]`);
      tag.classList.toggle('selected');
      tag.style.opacity = tag.classList.contains('selected') ? '1' : '0.5';
    }

    function calculateConversion() {
      const amount = parseFloat(document.getElementById('receiveAmount').value) || 0;
      if (!selectedMClass || amount <= 0) {
        document.getElementById('conversionPreview').style.display = 'none';
        return;
      }
      
      const cls = classifications[selectedMClass];
      const rate = cls?.conversion_rate || 1;
      const humPercent = cls?.humanitarian_percent || 0;
      
      const converted = amount * rate;
      const humanitarian = converted * (humPercent / 100);
      const net = converted - humanitarian;
      
      document.getElementById('previewOriginal').textContent = formatNumber(amount);
      document.getElementById('previewRate').textContent = (rate * 100).toFixed(0) + '%';
      document.getElementById('previewNet').textContent = formatNumber(net);
      document.getElementById('previewHumanitarian').textContent = `${formatNumber(humanitarian)} (${humPercent}%)`;
      document.getElementById('previewIGT').textContent = net.toLocaleString() + ' IGT';
      document.getElementById('conversionPreview').style.display = 'block';
    }

    async function receiveFunds(convertToIGT = false) {
      if (!selectedMClass) {
        alert('Please select a monetary classification');
        return;
      }
      
      const amount = parseFloat(document.getElementById('receiveAmount').value);
      if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      const entityType = document.getElementById('receiveEntityType').value;
      const entityId = document.getElementById('receiveEntity').value;
      const entity = allEntities.find(e => e.entity_type === entityType && e.id == entityId);
      
      const data = {
        entity_type: entityType,
        entity_id: entityId,
        entity_name: entity?.display_name || entity?.name || 'Unknown',
        mclass: selectedMClass,
        amount_usd: amount
      };
      
      const res = await api('/api/monetary/receive', 'POST', data);
      
      if (res.ok) {
        let msg = `Funds received successfully!\n\nClass: ${res.mclass}\nAmount: ${formatNumber(res.total_received)}\nHoldings Created: ${res.holdings_created}`;
        
        if (res.conversion_info) {
          msg += `\n\nConversion Info:\n- Rate to M0: ${(res.conversion_info.rate_to_m0 * 100).toFixed(0)}%\n- Humanitarian: ${res.conversion_info.humanitarian_percent}%\n- Potential M0 Value: ${formatNumber(res.conversion_info.potential_m0_value)}`;
        }
        
        alert(msg);
        document.getElementById('receiveAmount').value = '';
        loadDashboard();
      } else {
        alert(res.error || 'Failed to receive funds');
      }
    }

    async function loadDashboard() {
      const data = await api('/api/monetary/dashboard');
      
      // Update holdings stats
      const statsHtml = data.classifications?.map(c => `
        <div class="col-md-2">
          <div class="stat-card" style="border-left:4px solid ${c.color}">
            <div class="stat-value" style="color:${c.color}">${c.code}</div>
            <div class="stat-label">${formatNumber(c.total_value)}</div>
            <small class="text-muted">${c.holdings_count} holdings</small>
          </div>
        </div>
      `).join('') || '';
      
      if (document.getElementById('holdingsStats')) {
        document.getElementById('holdingsStats').innerHTML = statsHtml;
      }
    }

    async function loadHoldings() {
      const filter = document.getElementById('holdingsFilter')?.value || '';
      let url = '/api/monetary/holdings';
      if (filter) url += `?mclass=${filter}`;
      
      const holdings = await api(url);
      
      const html = holdings.map(h => `
        <tr>
          <td>${h.entity_name}</td>
          <td><span class="badge" style="background:${classifications[h.mclass]?.color || '#666'}">${h.mclass}</span></td>
          <td>${h.asset_name}</td>
          <td>${h.quantity} ${h.unit}</td>
          <td>${formatNumber(h.value_usd)}</td>
          <td><small class="text-muted">${h.certificate_number}</small></td>
          <td><span class="badge ${h.status === 'active' ? 'bg-success' : 'bg-secondary'}">${h.status}</span></td>
        </tr>
      `).join('') || '<tr><td colspan="7" class="text-center text-muted">No holdings found</td></tr>';
      
      document.getElementById('holdingsTable').innerHTML = html;
      loadDashboard();
    }

    async function loadEntityHoldings() {
      const entityType = document.getElementById('convertEntityType').value;
      const entityId = document.getElementById('convertEntity').value;
      
      const holdings = await api(`/api/monetary/holdings?entity_type=${entityType}&entity_id=${entityId}`);
      const activeHoldings = holdings.filter(h => h.status === 'active' && h.mclass !== 'M0');
      
      const html = activeHoldings.map(h => `
        <div class="form-check p-2 border-bottom">
          <input class="form-check-input" type="checkbox" value="${h.id}" id="holding-${h.id}" onchange="updateConvertSummary()">
          <label class="form-check-label d-flex justify-content-between w-100" for="holding-${h.id}">
            <span>
              <span class="badge" style="background:${classifications[h.mclass]?.color || '#666'}">${h.mclass}</span>
              ${h.asset_name}
            </span>
            <span>${formatNumber(h.value_usd)}</span>
          </label>
        </div>
      `).join('') || '<p class="text-muted p-2">No convertible holdings found</p>';
      
      document.getElementById('convertHoldingsList').innerHTML = html;
      updateConvertSummary();
    }

    function updateConvertSummary() {
      const checked = [...document.querySelectorAll('#convertHoldingsList input:checked')].map(i => parseInt(i.value));
      
      if (checked.length === 0) {
        document.getElementById('convertSummary').innerHTML = '<p class="text-muted">Select holdings to see conversion summary</p>';
        return;
      }
      
      // Calculate totals (simplified - would need actual holdings data)
      const totalValue = checked.length * 100000; // Placeholder
      const conversionRate = 0.9;
      const humPercent = 15;
      const converted = totalValue * conversionRate;
      const humanitarian = converted * (humPercent / 100);
      const net = converted - humanitarian;
      
      document.getElementById('convertSummary').innerHTML = `
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-2">
            <span>Selected Holdings:</span>
            <strong>${checked.length}</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Total Value:</span>
            <strong>${formatNumber(totalValue)}</strong>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-2">
            <span>Conversion Rate:</span>
            <strong>${(conversionRate * 100).toFixed(0)}%</strong>
          </div>
          <div class="d-flex justify-content-between mb-2 text-warning">
            <span><i class="bi bi-heart me-1"></i>Humanitarian (${humPercent}%):</span>
            <strong>${formatNumber(humanitarian)}</strong>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-2 text-success h5">
            <span>Net IGT to Receive:</span>
            <strong>${formatNumber(net)}</strong>
          </div>
        </div>
      `;
      
      selectedHoldings = checked;
    }

    async function executeConversion() {
      if (selectedHoldings.length === 0) {
        alert('Please select holdings to convert');
        return;
      }
      
      const entityType = document.getElementById('convertEntityType').value;
      const entityId = document.getElementById('convertEntity').value;
      const entity = allEntities.find(e => e.entity_type === entityType && e.id == entityId);
      
      const data = {
        entity_type: entityType,
        entity_id: entityId,
        entity_name: entity?.display_name || entity?.name,
        from_mclass: 'M1', // Would need to determine from holdings
        holding_ids: selectedHoldings,
        convert_to_igt: true
      };
      
      const res = await api('/api/monetary/convert', 'POST', data);
      
      if (res.ok) {
        alert(`Conversion successful!\n\nOriginal Value: ${formatNumber(res.conversion.original_value)}\nHumanitarian Contribution: ${formatNumber(res.conversion.humanitarian_contribution)}\nNet IGT Received: ${formatNumber(res.conversion.net_received)}`);
        loadEntityHoldings();
        loadDashboard();
      } else {
        alert(res.error || 'Conversion failed');
      }
    }

    async function loadHumanitarian() {
      const data = await api('/api/monetary/humanitarian');
      
      document.getElementById('humCollected').textContent = formatNumber(data.total_collected || 0);
      document.getElementById('humDistributed').textContent = formatNumber(data.total_distributed || 0);
      document.getElementById('humBalance').textContent = formatNumber(data.balance || 0);
      
      const allocations = data.allocations || [];
      document.getElementById('humAllocations').innerHTML = allocations.map(a => `
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-1">
            <span><i class="bi bi-${a.id === 'MEDICAL' ? 'heart-pulse' : a.id === 'EDUCATION' ? 'book' : a.id === 'FOOD' ? 'basket' : a.id === 'HOUSING' ? 'house' : a.id === 'WATER' ? 'droplet' : 'shield'} me-1"></i>${a.name}</span>
            <span>${formatNumber(a.balance)} / ${formatNumber(a.collected)}</span>
          </div>
          <div class="progress">
            <div class="progress-bar bg-success" style="width:${a.collected > 0 ? (a.distributed / a.collected * 100) : 0}%"></div>
          </div>
          <small class="text-muted">Allocated: ${a.allocation}% â€¢ Distributed: ${formatNumber(a.distributed)}</small>
        </div>
      `).join('');
      
      const transactions = data.transactions || [];
      document.getElementById('humTransactions').innerHTML = transactions.slice(-20).reverse().map(t => `
        <tr>
          <td class="small">${new Date(t.created_at).toLocaleDateString()}</td>
          <td><span class="badge ${t.type === 'collection' ? 'bg-success' : 'bg-info'}">${t.type}</span></td>
          <td class="${t.type === 'collection' ? 'text-success' : ''}">${formatNumber(t.amount)}</td>
        </tr>
      `).join('') || '<tr><td colspan="3" class="text-center text-muted">No transactions yet</td></tr>';
    }
  </script>
</body>
</html>
