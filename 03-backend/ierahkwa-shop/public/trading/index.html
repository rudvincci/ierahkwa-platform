<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IGT Banking, Exchange & Trading | Ierahkwa Sovereign Blockchain</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1; --primary-dark: #4f46e5; --success: #10b981; --warning: #f59e0b;
      --danger: #ef4444; --info: #06b6d4; --purple: #8b5cf6; --pink: #ec4899;
      --bg-dark: #0f172a; --bg-card: #1e293b; --bg-input: #334155; 
      --border: #475569; --text: #f1f5f9; --text-muted: #94a3b8;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
    .navbar { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid var(--border); }
    .navbar-brand { font-weight: 700; color: var(--primary) !important; }
    .nav-link { color: var(--text-muted) !important; }
    .nav-link:hover, .nav-link.active { color: var(--primary) !important; }
    .btn-primary { background: var(--primary); border-color: var(--primary); }
    .btn-primary:hover { background: var(--primary-dark); border-color: var(--primary-dark); }
    .btn-success { background: var(--success); border-color: var(--success); }
    .btn-danger { background: var(--danger); border-color: var(--danger); }
    .btn-purple { background: var(--purple); border-color: var(--purple); color: white; }
    .btn-pink { background: var(--pink); border-color: var(--pink); color: white; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
    .card-header { background: transparent; border-bottom: 1px solid var(--border); }
    .table { color: var(--text); }
    .table th { color: var(--text-muted); border-color: var(--border); font-weight: 500; font-size: 0.75rem; text-transform: uppercase; }
    .table td { border-color: rgba(255,255,255,0.05); vertical-align: middle; font-size: 0.9rem; }
    .table-hover tbody tr:hover { background: rgba(99,102,241,0.1); }
    .form-control, .form-select { background: var(--bg-input); border-color: var(--border); color: var(--text); }
    .form-control:focus, .form-select:focus { background: var(--bg-input); border-color: var(--primary); color: var(--text); box-shadow: 0 0 0 2px rgba(99,102,241,0.25); }
    .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, rgba(99,102,241,0.1) 100%); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border); }
    .stat-card .stat-value { font-size: 1.5rem; font-weight: 700; }
    .stat-card .stat-label { color: var(--text-muted); font-size: 0.8rem; }
    .stat-card .stat-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .badge-success { background: rgba(16,185,129,0.2); color: var(--success); }
    .badge-danger { background: rgba(239,68,68,0.2); color: var(--danger); }
    .badge-warning { background: rgba(245,158,11,0.2); color: var(--warning); }
    .badge-info { background: rgba(6,182,212,0.2); color: var(--info); }
    .badge-primary { background: rgba(99,102,241,0.2); color: var(--primary); }
    .badge-purple { background: rgba(139,92,246,0.2); color: var(--purple); }
    .badge-pink { background: rgba(236,72,153,0.2); color: var(--pink); }
    .entity-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; transition: all 0.2s; }
    .entity-card:hover { border-color: var(--primary); transform: translateY(-2px); }
    .entity-card .entity-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .account-box { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 1rem; margin-top: 0.75rem; }
    .account-box h6 { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem; }
    .order-book { max-height: 350px; overflow-y: auto; }
    .order-book .bid { background: rgba(16,185,129,0.1); }
    .order-book .ask { background: rgba(239,68,68,0.1); }
    .trade-form { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border); }
    .trade-tabs .nav-link { color: var(--text-muted); border: none; padding: 0.6rem 1.25rem; }
    .trade-tabs .nav-link.active { background: var(--primary); color: white; border-radius: 8px; }
    .token-logo { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.7rem; }
    .modal-content { background: var(--bg-card); border: 1px solid var(--border); }
    .modal-header, .modal-footer { border-color: var(--border); }
    .btn-close { filter: invert(1); }
    .nav-tabs { border-bottom: 1px solid var(--border); }
    .nav-tabs .nav-link { color: var(--text-muted); border: none; padding: 0.75rem 1.25rem; }
    .nav-tabs .nav-link:hover { color: var(--text); border: none; }
    .nav-tabs .nav-link.active { color: var(--primary); background: transparent; border: none; border-bottom: 2px solid var(--primary); }
    .entity-type-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); }
    .entity-type-header h5 { margin: 0; }
    @media (max-width: 768px) { .stat-card { margin-bottom: 1rem; } }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="/trading">
        <i class="bi bi-bank2 me-2"></i>IGT Banking & Trading
      </a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link active" href="#" onclick="showSection('dashboard')"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('central-banks')"><i class="bi bi-bank me-1"></i>Central Banks</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('futurehead')"><i class="bi bi-building me-1"></i>Futurehead</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('governments')"><i class="bi bi-flag me-1"></i>Governments</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('departments')"><i class="bi bi-diagram-3 me-1"></i>Departments</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('trading')"><i class="bi bi-graph-up me-1"></i>Trading</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('exchange')"><i class="bi bi-arrow-left-right me-1"></i>Exchange</a></li>
        </ul>
        <div class="d-flex gap-2">
          <a href="/global-banking" class="btn btn-outline-success btn-sm"><i class="bi bi-globe2"></i> Banks</a>
          <a href="/monetary" class="btn btn-outline-info btn-sm"><i class="bi bi-stack"></i> M0-M4</a>
          <a href="/backup" class="btn btn-outline-warning btn-sm"><i class="bi bi-hdd-stack"></i></a>
          <a href="/" class="btn btn-outline-light btn-sm"><i class="bi bi-shop"></i></a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-4 py-4">
    <!-- Dashboard Section -->
    <section id="section-dashboard" class="section">
      <div class="row g-3 mb-4">
        <div class="col-md-2">
          <div class="stat-card">
            <div class="d-flex justify-content-between">
              <div>
                <div class="stat-value" id="statCentralBanks">0</div>
                <div class="stat-label">Central Banks</div>
              </div>
              <div class="stat-icon bg-danger bg-opacity-25 text-danger"><i class="bi bi-bank"></i></div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card">
            <div class="d-flex justify-content-between">
              <div>
                <div class="stat-value" id="statFuturehead">0</div>
                <div class="stat-label">Futurehead</div>
              </div>
              <div class="stat-icon bg-purple bg-opacity-25 text-purple" style="color:var(--purple)"><i class="bi bi-building"></i></div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card">
            <div class="d-flex justify-content-between">
              <div>
                <div class="stat-value" id="statGovernments">0</div>
                <div class="stat-label">Governments</div>
              </div>
              <div class="stat-icon bg-warning bg-opacity-25 text-warning"><i class="bi bi-flag"></i></div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card">
            <div class="d-flex justify-content-between">
              <div>
                <div class="stat-value" id="statDepartments">0</div>
                <div class="stat-label">Departments</div>
              </div>
              <div class="stat-icon bg-info bg-opacity-25 text-info"><i class="bi bi-diagram-3"></i></div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card">
            <div class="d-flex justify-content-between">
              <div>
                <div class="stat-value" id="statIGT">0</div>
                <div class="stat-label">Total IGT</div>
              </div>
              <div class="stat-icon bg-success bg-opacity-25 text-success"><i class="bi bi-currency-exchange"></i></div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="stat-card">
            <div class="d-flex justify-content-between">
              <div>
                <div class="stat-value" id="statUSD">$0</div>
                <div class="stat-label">USD Reserves</div>
              </div>
              <div class="stat-icon bg-primary bg-opacity-25 text-primary"><i class="bi bi-cash-stack"></i></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Trades</h5>
              <span class="badge badge-primary" id="statVolume">$0 24h Vol</span>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead><tr><th>Time</th><th>Entity</th><th>Type</th><th>Pair</th><th>Side</th><th>Price</th><th>Amount</th><th>Total</th></tr></thead>
                  <tbody id="recentTradesTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-currency-exchange me-2"></i>Exchange Rates</h5></div>
            <div class="card-body" id="exchangeRatesPanel"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Central Banks Section -->
    <section id="section-central-banks" class="section d-none">
      <div class="entity-type-header">
        <div class="stat-icon bg-danger bg-opacity-25 text-danger"><i class="bi bi-bank"></i></div>
        <h5>Central Banks</h5>
        <span class="badge badge-danger ms-auto" id="cbCount">0 Banks</span>
      </div>
      <div class="row g-3" id="centralBanksList"></div>
    </section>

    <!-- Futurehead Section -->
    <section id="section-futurehead" class="section d-none">
      <div class="entity-type-header">
        <div class="stat-icon bg-purple bg-opacity-25" style="color:var(--purple)"><i class="bi bi-building"></i></div>
        <h5>Futurehead Group Entities</h5>
        <span class="badge badge-purple ms-auto" id="fhCount">0 Entities</span>
      </div>
      <div class="row g-3" id="futureheadList"></div>
    </section>

    <!-- Governments Section -->
    <section id="section-governments" class="section d-none">
      <div class="entity-type-header">
        <div class="stat-icon bg-warning bg-opacity-25 text-warning"><i class="bi bi-flag"></i></div>
        <h5>Government Accounts</h5>
        <span class="badge badge-warning ms-auto" id="govCount">0 Governments</span>
      </div>
      <div class="row g-3" id="governmentsList"></div>
    </section>

    <!-- Departments Section -->
    <section id="section-departments" class="section d-none">
      <div class="entity-type-header">
        <div class="stat-icon bg-info bg-opacity-25 text-info"><i class="bi bi-diagram-3"></i></div>
        <h5>Department Accounts</h5>
        <input type="text" class="form-control w-25 ms-auto" id="deptSearch" placeholder="Search departments..." onkeyup="filterDepartments()">
      </div>
      <div class="row g-3" id="departmentsList"></div>
    </section>

    <!-- Trading Section -->
    <section id="section-trading" class="section d-none">
      <div class="row g-4">
        <div class="col-md-3">
          <div class="card">
            <div class="card-header"><h6 class="mb-0">Trading Pairs</h6></div>
            <div class="card-body p-0">
              <div class="list-group list-group-flush" id="tradingPairsList" style="max-height:500px;overflow-y:auto"></div>
            </div>
          </div>
        </div>
        <div class="col-md-5">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0" id="selectedPairTitle">IGT/USD</h6>
              <span class="badge badge-success" id="selectedPairPrice">$1.00</span>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <h6 class="text-success small">Bids (Buy Orders)</h6>
                  <div class="order-book" id="bidsBook"></div>
                </div>
                <div class="col-6">
                  <h6 class="text-danger small">Asks (Sell Orders)</h6>
                  <div class="order-book" id="asksBook"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="trade-form">
            <ul class="nav nav-pills trade-tabs mb-3">
              <li class="nav-item"><a class="nav-link active" data-side="buy" href="#">Buy</a></li>
              <li class="nav-item"><a class="nav-link" data-side="sell" href="#">Sell</a></li>
            </ul>
            <form id="tradeForm" onsubmit="submitTrade(event)">
              <div class="mb-3">
                <label class="form-label small">Entity Type</label>
                <select class="form-select" id="tradeEntityType" onchange="loadTradeEntities()">
                  <option value="central_bank">Central Bank</option>
                  <option value="futurehead">Futurehead</option>
                  <option value="government">Government</option>
                  <option value="department">Department</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label small">Entity</label>
                <select class="form-select" id="tradeEntity" required></select>
              </div>
              <div class="mb-3">
                <label class="form-label small">Order Type</label>
                <select class="form-select" id="tradeType">
                  <option value="market">Market Order</option>
                  <option value="limit">Limit Order</option>
                </select>
              </div>
              <div class="mb-3 d-none" id="tradePriceGroup">
                <label class="form-label small">Price</label>
                <input type="number" class="form-control" id="tradePrice" step="0.0001" placeholder="0.00">
              </div>
              <div class="mb-3">
                <label class="form-label small">Amount</label>
                <input type="number" class="form-control" id="tradeAmount" step="0.0001" required placeholder="0.00">
              </div>
              <div class="mb-3">
                <label class="form-label small">Total (estimated)</label>
                <input type="text" class="form-control" id="tradeTotal" readonly placeholder="0.00">
              </div>
              <input type="hidden" id="tradeSide" value="buy">
              <input type="hidden" id="tradePair" value="IGT/USD">
              <button type="submit" class="btn btn-success w-100" id="tradeBtn">Buy IGT</button>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Exchange Section -->
    <section id="section-exchange" class="section d-none">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-arrow-left-right me-2"></i>Currency Exchange</h5></div>
            <div class="card-body">
              <form id="exchangeForm" onsubmit="submitExchange(event)">
                <div class="mb-3">
                  <label class="form-label">Entity Type</label>
                  <select class="form-select" id="exchEntityType" onchange="loadExchangeEntities()">
                    <option value="central_bank">Central Bank</option>
                    <option value="futurehead">Futurehead</option>
                    <option value="government">Government</option>
                    <option value="department">Department</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Entity</label>
                  <select class="form-select" id="exchEntity" required></select>
                </div>
                <div class="mb-3">
                  <label class="form-label">From Currency</label>
                  <select class="form-select" id="exchangeFrom">
                    <option value="IGT">IGT Token</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="BTC">Bitcoin</option>
                    <option value="ETH">Ethereum</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Amount</label>
                  <input type="number" class="form-control" id="exchangeAmount" step="0.0001" required placeholder="Enter amount">
                </div>
                <div class="text-center my-3">
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="swapCurrencies()">
                    <i class="bi bi-arrow-down-up"></i> Swap
                  </button>
                </div>
                <div class="mb-3">
                  <label class="form-label">To Currency</label>
                  <select class="form-select" id="exchangeTo">
                    <option value="USD">USD</option>
                    <option value="IGT">IGT Token</option>
                    <option value="EUR">EUR</option>
                    <option value="BTC">Bitcoin</option>
                    <option value="ETH">Ethereum</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">You will receive (estimated)</label>
                  <input type="text" class="form-control" id="exchangeReceive" readonly placeholder="0.00">
                </div>
                <div class="alert alert-info small mb-3">
                  <i class="bi bi-info-circle me-1"></i> Exchange fee: 0.5%
                </div>
                <button type="submit" class="btn btn-primary w-100">Exchange Now</button>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header"><h6 class="mb-0">Live Exchange Rates</h6></div>
            <div class="card-body" id="exchangeRates"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Entity Detail Modal -->
  <div class="modal fade" id="entityModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entityModalTitle">Entity Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="entityModalBody"></div>
      </div>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-send me-2"></i>Transfer Funds</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="transferForm" onsubmit="submitTransfer(event)">
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-6">
                <label class="form-label">From Type</label>
                <select class="form-select" id="transferFromType" onchange="loadTransferFromEntities()">
                  <option value="central_bank">Central Bank</option>
                  <option value="futurehead">Futurehead</option>
                  <option value="government">Government</option>
                  <option value="department">Department</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">From Entity</label>
                <select class="form-select" id="transferFrom" required></select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-6">
                <label class="form-label">To Type</label>
                <select class="form-select" id="transferToType" onchange="loadTransferToEntities()">
                  <option value="central_bank">Central Bank</option>
                  <option value="futurehead">Futurehead</option>
                  <option value="government">Government</option>
                  <option value="department">Department</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">To Entity</label>
                <select class="form-select" id="transferTo" required></select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Currency</label>
              <select class="form-select" id="transferCurrency">
                <option value="IGT">IGT</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="BTC">BTC</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Amount</label>
              <input type="number" class="form-control" id="transferAmount" step="0.01" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Reference (optional)</label>
              <input type="text" class="form-control" id="transferRef">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Transfer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allEntities = [];
    let centralBanks = [];
    let futureheadEntities = [];
    let governments = [];
    let departments = [];
    let tokens = [];
    let pairs = [];
    let exchangeRates = {};
    let selectedPair = 'IGT/USD';
    let tradeSide = 'buy';

    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
      loadAllEntities();
      loadPairs();
      setupTradeForm();
    });

    function showSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
      document.getElementById('section-' + name).classList.remove('d-none');
      document.querySelectorAll('.navbar-nav .nav-link').forEach(l => l.classList.remove('active'));
      event.target.classList.add('active');
    }

    async function api(url, method = 'GET', data = null) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (data) opts.body = JSON.stringify(data);
      const res = await fetch(url, opts);
      return res.json();
    }

    function formatNumber(n, decimals = 2) {
      if (n >= 1e15) return (n / 1e15).toFixed(decimals) + 'Q';
      if (n >= 1e12) return (n / 1e12).toFixed(decimals) + 'T';
      if (n >= 1e9) return (n / 1e9).toFixed(decimals) + 'B';
      if (n >= 1e6) return (n / 1e6).toFixed(decimals) + 'M';
      if (n >= 1e3) return (n / 1e3).toFixed(decimals) + 'K';
      return n.toFixed(decimals);
    }

    async function loadDashboard() {
      const data = await api('/api/banking/dashboard');
      document.getElementById('statCentralBanks').textContent = data.stats?.central_banks || 0;
      document.getElementById('statFuturehead').textContent = data.stats?.futurehead_entities || 0;
      document.getElementById('statGovernments').textContent = data.stats?.governments || 0;
      document.getElementById('statDepartments').textContent = data.stats?.departments || 0;
      document.getElementById('statIGT').textContent = formatNumber(data.stats?.total_igt_supply || 0, 0);
      document.getElementById('statUSD').textContent = '$' + formatNumber(data.stats?.total_usd_reserves || 0);
      document.getElementById('statVolume').textContent = '$' + formatNumber(data.stats?.volume_24h || 0) + ' 24h Vol';

      exchangeRates = data.exchange_rates || {};
      renderExchangeRates();

      const tradesHtml = (data.recent_trades || []).map(t => `
        <tr>
          <td class="small">${new Date(t.created_at).toLocaleTimeString()}</td>
          <td>${(t.entity_name || '-').substring(0, 20)}</td>
          <td><span class="badge badge-${getEntityBadge(t.entity_type)}">${t.entity_type || '-'}</span></td>
          <td><span class="badge badge-info">${t.pair_symbol}</span></td>
          <td><span class="badge ${t.side === 'buy' ? 'badge-success' : 'badge-danger'}">${t.side}</span></td>
          <td>$${(t.price || 0).toFixed(4)}</td>
          <td>${formatNumber(t.amount || 0)}</td>
          <td>$${formatNumber(t.total || 0)}</td>
        </tr>
      `).join('') || '<tr><td colspan="8" class="text-center text-muted">No recent trades</td></tr>';
      document.getElementById('recentTradesTable').innerHTML = tradesHtml;
    }

    function getEntityBadge(type) {
      const badges = { central_bank: 'danger', futurehead: 'purple', government: 'warning', department: 'info' };
      return badges[type] || 'primary';
    }

    function renderExchangeRates() {
      const html = Object.entries(exchangeRates)
        .filter(([k]) => !['updated_at'].includes(k))
        .map(([k, v]) => `<div class="d-flex justify-content-between mb-2"><span>${k}</span><span>$${formatNumber(v)}</span></div>`)
        .join('');
      document.getElementById('exchangeRatesPanel').innerHTML = html + `<hr><small class="text-muted">Updated: ${new Date(exchangeRates.updated_at).toLocaleString()}</small>`;
      document.getElementById('exchangeRates').innerHTML = html;
    }

    async function loadAllEntities() {
      allEntities = await api('/api/banking/all-entities');
      centralBanks = allEntities.filter(e => e.entity_type === 'central_bank');
      futureheadEntities = allEntities.filter(e => e.entity_type === 'futurehead');
      governments = allEntities.filter(e => e.entity_type === 'government');
      departments = allEntities.filter(e => e.entity_type === 'department');
      
      renderCentralBanks();
      renderFuturehead();
      renderGovernments();
      renderDepartments();
      loadTradeEntities();
      loadExchangeEntities();
      loadTransferFromEntities();
      loadTransferToEntities();
    }

    function renderEntityCard(entity, color) {
      const bankAcc = entity.bank_account || {};
      const exchAcc = entity.exchange_account || {};
      const tradeDeck = entity.trading_deck || {};
      
      return `
        <div class="col-md-6 col-lg-4">
          <div class="entity-card">
            <div class="d-flex align-items-start gap-3 mb-3">
              <div class="entity-icon bg-${color} bg-opacity-25 text-${color}">
                <i class="bi bi-${entity.entity_type === 'central_bank' ? 'bank' : entity.entity_type === 'futurehead' ? 'building' : entity.entity_type === 'government' ? 'flag' : 'diagram-3'}"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">${entity.display_name || entity.name}</h6>
                <small class="text-muted">${entity.code || entity.token_symbol || ''} ${entity.type ? 'â€¢ ' + entity.type : ''}</small>
              </div>
              <button class="btn btn-sm btn-outline-${color}" onclick="viewEntity('${entity.entity_type}', '${entity.id}')">
                <i class="bi bi-eye"></i>
              </button>
            </div>
            
            <div class="account-box">
              <h6><i class="bi bi-wallet2 me-1"></i>Bank Account</h6>
              <div class="d-flex justify-content-between small">
                <span>IGT:</span><span class="text-success">${formatNumber(bankAcc.igt_balance || 0)}</span>
              </div>
              <div class="d-flex justify-content-between small">
                <span>USD:</span><span>$${formatNumber(bankAcc.usd_balance || 0)}</span>
              </div>
            </div>
            
            <div class="account-box">
              <h6><i class="bi bi-arrow-left-right me-1"></i>Exchange Account</h6>
              <div class="d-flex justify-content-between small">
                <span>Daily Limit:</span><span>$${formatNumber(exchAcc.trading_limit_daily || 0)}</span>
              </div>
              <div class="d-flex justify-content-between small">
                <span>Liquidity Pool:</span><span>$${formatNumber(exchAcc.liquidity_pool || 0)}</span>
              </div>
            </div>
            
            <div class="account-box">
              <h6><i class="bi bi-graph-up me-1"></i>Trading Deck</h6>
              <div class="d-flex justify-content-between small">
                <span>Margin:</span><span>$${formatNumber(tradeDeck.margin_available || 0)}</span>
              </div>
              <div class="d-flex justify-content-between small">
                <span>Leverage:</span><span>${tradeDeck.leverage_limit || 0}x</span>
              </div>
            </div>
            
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-sm btn-outline-success flex-fill" onclick="showTransferFrom('${entity.entity_type}', '${entity.id}')">
                <i class="bi bi-send me-1"></i>Transfer
              </button>
              <button class="btn btn-sm btn-outline-primary flex-fill" onclick="quickTrade('${entity.entity_type}', '${entity.id}')">
                <i class="bi bi-graph-up me-1"></i>Trade
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderCentralBanks() {
      document.getElementById('cbCount').textContent = `${centralBanks.length} Banks`;
      document.getElementById('centralBanksList').innerHTML = centralBanks.map(cb => renderEntityCard(cb, 'danger')).join('');
    }

    function renderFuturehead() {
      document.getElementById('fhCount').textContent = `${futureheadEntities.length} Entities`;
      document.getElementById('futureheadList').innerHTML = futureheadEntities.map(fh => renderEntityCard({...fh, entity_type: 'futurehead'}, 'purple')).join('');
    }

    function renderGovernments() {
      document.getElementById('govCount').textContent = `${governments.length} Governments`;
      document.getElementById('governmentsList').innerHTML = governments.map(g => renderEntityCard(g, 'warning')).join('');
    }

    function renderDepartments() {
      const search = document.getElementById('deptSearch')?.value?.toLowerCase() || '';
      const filtered = departments.filter(d => 
        (d.display_name || d.department_name || '').toLowerCase().includes(search) ||
        (d.token_symbol || '').toLowerCase().includes(search)
      );
      document.getElementById('departmentsList').innerHTML = filtered.map(d => renderEntityCard(d, 'info')).join('');
    }

    function filterDepartments() { renderDepartments(); }

    async function viewEntity(type, id) {
      let data;
      if (type === 'central_bank') data = await api(`/api/banking/central-banks/${id}`);
      else if (type === 'futurehead') data = await api(`/api/banking/futurehead/${id}`);
      else if (type === 'government') data = await api(`/api/banking/governments/${id}`);
      else data = await api(`/api/banking/accounts/${id}`);

      const bankAcc = data.bank_account || {};
      const exchAcc = data.exchange_account || {};
      const tradeDeck = data.trading_deck || {};
      
      document.getElementById('entityModalTitle').innerHTML = `
        <i class="bi bi-${type === 'central_bank' ? 'bank' : type === 'futurehead' ? 'building' : type === 'government' ? 'flag' : 'diagram-3'} me-2"></i>
        ${data.name || data.department_name}
      `;
      
      document.getElementById('entityModalBody').innerHTML = `
        <ul class="nav nav-tabs mb-3" id="entityTabs">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-bank">Bank Account</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-exchange">Exchange Account</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-trading">Trading Deck</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-history">Transaction History</a></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tab-bank">
            <div class="row g-3">
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value text-success">${formatNumber(bankAcc.igt_balance || 0)}</div>
                  <div class="stat-label">IGT Balance</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value">$${formatNumber(bankAcc.usd_balance || 0)}</div>
                  <div class="stat-label">USD Balance</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value">${formatNumber(bankAcc.eur_balance || 0)}</div>
                  <div class="stat-label">EUR Balance</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value">${formatNumber(bankAcc.btc_balance || 0, 4)}</div>
                  <div class="stat-label">BTC Balance</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value">${formatNumber(bankAcc.eth_balance || 0, 4)}</div>
                  <div class="stat-label">ETH Balance</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value">${bankAcc.account_number || '-'}</div>
                  <div class="stat-label">Account Number</div>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tab-exchange">
            <div class="row g-3">
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value">$${formatNumber(exchAcc.trading_limit_daily || 0)}</div>
                  <div class="stat-label">Daily Limit</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value">$${formatNumber(exchAcc.liquidity_pool || 0)}</div>
                  <div class="stat-label">Liquidity Pool</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-value">${(exchAcc.maker_fee || 0.005) * 100}%</div>
                  <div class="stat-label">Maker Fee</div>
                </div>
              </div>
              <div class="col-12">
                <h6 class="mt-3">Enabled Services</h6>
                <div class="d-flex gap-2 flex-wrap">
                  ${exchAcc.forex_enabled ? '<span class="badge badge-success">Forex</span>' : ''}
                  ${exchAcc.crypto_enabled ? '<span class="badge badge-primary">Crypto</span>' : ''}
                  ${exchAcc.commodities_enabled ? '<span class="badge badge-warning">Commodities</span>' : ''}
                  ${exchAcc.derivatives_enabled ? '<span class="badge badge-info">Derivatives</span>' : ''}
                  ${exchAcc.bond_trading_enabled ? '<span class="badge badge-purple">Bonds</span>' : ''}
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tab-trading">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-value">$${formatNumber(tradeDeck.margin_available || 0)}</div>
                  <div class="stat-label">Margin Available</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-value">${tradeDeck.leverage_limit || 0}x</div>
                  <div class="stat-label">Max Leverage</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-value ${(tradeDeck.daily_pnl || 0) >= 0 ? 'text-success' : 'text-danger'}">
                    $${formatNumber(tradeDeck.daily_pnl || 0)}
                  </div>
                  <div class="stat-label">Daily P&L</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-value">$${formatNumber(tradeDeck.risk_limit || 0)}</div>
                  <div class="stat-label">Risk Limit</div>
                </div>
              </div>
              <div class="col-12">
                <h6 class="mt-3">Features</h6>
                <div class="d-flex gap-2 flex-wrap">
                  ${tradeDeck.algo_trading_enabled ? '<span class="badge badge-success">Algo Trading</span>' : ''}
                  ${tradeDeck.api_access ? '<span class="badge badge-primary">API Access</span>' : ''}
                  <span class="badge badge-info">Account: ${tradeDeck.account_number || '-'}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tab-history">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead><tr><th>Date</th><th>Type</th><th>Currency</th><th>Amount</th><th>Reference</th></tr></thead>
                <tbody>${(data.transactions || []).slice(0, 20).map(t => `
                  <tr>
                    <td class="small">${new Date(t.created_at).toLocaleString()}</td>
                    <td><span class="badge badge-${t.type.includes('in') || t.type === 'deposit' ? 'success' : 'danger'}">${t.type}</span></td>
                    <td>${t.currency}</td>
                    <td class="${t.amount > 0 ? 'text-success' : 'text-danger'}">${t.amount > 0 ? '+' : ''}${formatNumber(t.amount)}</td>
                    <td class="small text-muted">${t.reference || '-'}</td>
                  </tr>
                `).join('') || '<tr><td colspan="5" class="text-center">No transactions</td></tr>'}</tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      new bootstrap.Modal(document.getElementById('entityModal')).show();
    }

    // Transfer functions
    function showTransferFrom(type, id) {
      document.getElementById('transferFromType').value = type;
      loadTransferFromEntities();
      setTimeout(() => { document.getElementById('transferFrom').value = id; }, 100);
      new bootstrap.Modal(document.getElementById('transferModal')).show();
    }

    function loadTransferFromEntities() {
      const type = document.getElementById('transferFromType').value;
      const entities = allEntities.filter(e => e.entity_type === type);
      document.getElementById('transferFrom').innerHTML = entities.map(e => 
        `<option value="${e.id}">${e.display_name || e.name} (${e.code || e.token_symbol || ''})</option>`
      ).join('');
    }

    function loadTransferToEntities() {
      const type = document.getElementById('transferToType').value;
      const entities = allEntities.filter(e => e.entity_type === type);
      document.getElementById('transferTo').innerHTML = entities.map(e => 
        `<option value="${e.id}">${e.display_name || e.name} (${e.code || e.token_symbol || ''})</option>`
      ).join('');
    }

    async function submitTransfer(e) {
      e.preventDefault();
      const data = {
        from_type: document.getElementById('transferFromType').value,
        from_id: document.getElementById('transferFrom').value,
        to_type: document.getElementById('transferToType').value,
        to_id: document.getElementById('transferTo').value,
        currency: document.getElementById('transferCurrency').value,
        amount: parseFloat(document.getElementById('transferAmount').value),
        reference: document.getElementById('transferRef').value
      };
      const res = await api('/api/banking/transfer', 'POST', data);
      if (res.ok) {
        bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide();
        loadAllEntities();
        loadDashboard();
        alert('Transfer successful!');
      } else {
        alert(res.error || 'Transfer failed');
      }
    }

    // Trading functions
    async function loadPairs() {
      pairs = await api('/api/trading/pairs');
      const html = pairs.filter(p => p.quote === 'USD').slice(0, 20).map(p => `
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between ${p.symbol === selectedPair ? 'active' : ''}" onclick="selectPair('${p.symbol}')">
          <span>${p.symbol}</span>
          <span class="small">$${(p.price || 0).toFixed(4)}</span>
        </a>
      `).join('');
      document.getElementById('tradingPairsList').innerHTML = html;
      loadOrderBook(selectedPair);
    }

    function selectPair(symbol) {
      selectedPair = symbol;
      document.getElementById('tradePair').value = symbol;
      document.getElementById('selectedPairTitle').textContent = symbol;
      loadPairs();
    }

    async function loadOrderBook(symbol) {
      const data = await api(`/api/trading/pairs/${symbol}`);
      document.getElementById('selectedPairPrice').textContent = '$' + (data.price || 0).toFixed(4);
      
      const bids = (data.order_book?.bids || []).slice(0, 8).map(o => `
        <div class="bid d-flex justify-content-between small p-1 mb-1 rounded">
          <span class="text-success">$${o.price.toFixed(4)}</span>
          <span>${formatNumber(o.amount)}</span>
        </div>
      `).join('') || '<p class="text-muted small">No bids</p>';
      
      const asks = (data.order_book?.asks || []).slice(0, 8).map(o => `
        <div class="ask d-flex justify-content-between small p-1 mb-1 rounded">
          <span class="text-danger">$${o.price.toFixed(4)}</span>
          <span>${formatNumber(o.amount)}</span>
        </div>
      `).join('') || '<p class="text-muted small">No asks</p>';
      
      document.getElementById('bidsBook').innerHTML = bids;
      document.getElementById('asksBook').innerHTML = asks;
    }

    function loadTradeEntities() {
      const type = document.getElementById('tradeEntityType').value;
      const entities = allEntities.filter(e => e.entity_type === type);
      document.getElementById('tradeEntity').innerHTML = entities.map(e => 
        `<option value="${e.id}">${e.display_name || e.name} (${e.code || e.token_symbol || ''})</option>`
      ).join('');
    }

    function quickTrade(type, id) {
      showSection('trading');
      document.getElementById('tradeEntityType').value = type;
      loadTradeEntities();
      setTimeout(() => { document.getElementById('tradeEntity').value = id; }, 100);
    }

    function setupTradeForm() {
      document.querySelectorAll('.trade-tabs .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.trade-tabs .nav-link').forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          tradeSide = link.dataset.side;
          document.getElementById('tradeSide').value = tradeSide;
          const btn = document.getElementById('tradeBtn');
          btn.textContent = `${tradeSide === 'buy' ? 'Buy' : 'Sell'} ${selectedPair.split('/')[0]}`;
          btn.className = `btn w-100 ${tradeSide === 'buy' ? 'btn-success' : 'btn-danger'}`;
        });
      });

      document.getElementById('tradeType').addEventListener('change', (e) => {
        document.getElementById('tradePriceGroup').classList.toggle('d-none', e.target.value === 'market');
      });

      ['tradePrice', 'tradeAmount'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calculateTotal);
      });
    }

    function calculateTotal() {
      const price = parseFloat(document.getElementById('tradePrice').value) || pairs.find(p => p.symbol === selectedPair)?.price || 1;
      const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
      document.getElementById('tradeTotal').value = '$' + (price * amount).toFixed(4);
    }

    async function submitTrade(e) {
      e.preventDefault();
      const data = {
        entity_type: document.getElementById('tradeEntityType').value,
        entity_id: document.getElementById('tradeEntity').value,
        pair_symbol: selectedPair,
        side: tradeSide,
        type: document.getElementById('tradeType').value,
        price: document.getElementById('tradePrice').value,
        amount: document.getElementById('tradeAmount').value
      };
      const res = await api('/api/trading/order', 'POST', data);
      if (res.ok) {
        alert(`Order ${res.status}: #${res.order_id}`);
        loadDashboard();
        loadAllEntities();
        loadOrderBook(selectedPair);
        document.getElementById('tradeForm').reset();
      } else {
        alert(res.error || 'Trade failed');
      }
    }

    // Exchange functions
    function loadExchangeEntities() {
      const type = document.getElementById('exchEntityType').value;
      const entities = allEntities.filter(e => e.entity_type === type);
      document.getElementById('exchEntity').innerHTML = entities.map(e => 
        `<option value="${e.id}">${e.display_name || e.name} (${e.code || e.token_symbol || ''})</option>`
      ).join('');
    }

    function swapCurrencies() {
      const from = document.getElementById('exchangeFrom');
      const to = document.getElementById('exchangeTo');
      [from.value, to.value] = [to.value, from.value];
      calculateExchange();
    }

    document.getElementById('exchangeAmount')?.addEventListener('input', calculateExchange);
    document.getElementById('exchangeFrom')?.addEventListener('change', calculateExchange);
    document.getElementById('exchangeTo')?.addEventListener('change', calculateExchange);

    function calculateExchange() {
      const from = document.getElementById('exchangeFrom').value;
      const to = document.getElementById('exchangeTo').value;
      const amount = parseFloat(document.getElementById('exchangeAmount').value) || 0;
      
      const fromRate = exchangeRates[from] || 1;
      const toRate = exchangeRates[to] || 1;
      const usdValue = amount * fromRate;
      const toAmount = usdValue / toRate;
      const fee = toAmount * 0.005;
      
      document.getElementById('exchangeReceive').value = (toAmount - fee).toFixed(4) + ' ' + to;
    }

    async function submitExchange(e) {
      e.preventDefault();
      const data = {
        entity_type: document.getElementById('exchEntityType').value,
        entity_id: document.getElementById('exchEntity').value,
        from_currency: document.getElementById('exchangeFrom').value,
        to_currency: document.getElementById('exchangeTo').value,
        amount: parseFloat(document.getElementById('exchangeAmount').value)
      };
      const res = await api('/api/exchange/swap', 'POST', data);
      if (res.ok) {
        alert(`Exchange successful!\nReceived: ${res.to_amount.toFixed(4)}\nFee: ${res.fee.toFixed(4)}`);
        loadAllEntities();
        loadDashboard();
        document.getElementById('exchangeForm').reset();
      } else {
        alert(res.error || 'Exchange failed');
      }
    }
  </script>
</body>
</html>
