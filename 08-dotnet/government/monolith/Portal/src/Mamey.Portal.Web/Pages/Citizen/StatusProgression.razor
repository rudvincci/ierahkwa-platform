@page "/citizen/status-progression"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Citizen")]
@using Mamey.Portal.Citizenship.Application.Models
@using Mamey.Portal.Citizenship.Application.Services
@using Mamey.Portal.Web.ViewModels.Citizenship
@using Mamey.Portal.Shared.Auth
@inject IStatusProgressionService ProgressionService
@inject ICitizenshipStatusService StatusService
@inject ICurrentUserContext UserContext
@inject NavigationManager Navigation

<PageTitle>Status Progression</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4">Citizenship Status Progression</MudText>
    <MudText Typo="Typo.body1">
        Apply to progress from Probationary → Resident → Citizen status. Each progression requires meeting time requirements and approval.
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }

    @if (_currentStatus is not null)
    {
        <MudPaper Class="pa-4">
            <MudStack Spacing="3">
                <div>
                    <MudText Typo="Typo.h6">Current Status</MudText>
                    <MudDivider Class="my-2" />
                </div>

                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.body2"><strong>Status:</strong></MudText>
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_currentStatus.Status)">
                            @_currentStatus.Status
                        </MudChip>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.body2"><strong>Years Completed:</strong></MudText>
                        <MudText Typo="Typo.body1">@_currentStatus.YearsCompleted years</MudText>
                    </MudItem>
                    @if (_currentStatus.StatusExpiresAt.HasValue)
                    {
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.body2"><strong>Status Expires:</strong></MudText>
                            <MudText Typo="Typo.body1">@_currentStatus.StatusExpiresAt.Value.LocalDateTime.ToString("yyyy-MM-dd")</MudText>
                        </MudItem>
                    }
                </MudGrid>
            </MudStack>
        </MudPaper>
    }

    @if (_residentEligibility is not null)
    {
        <MudPaper Class="pa-4">
            <MudStack Spacing="3">
                <div>
                    <MudText Typo="Typo.h6">Apply for Resident Status</MudText>
                    <MudDivider Class="my-2" />
                </div>

                <MudText Typo="Typo.body2">
                    <strong>Requirements:</strong> Complete 2 years as Probationary
                </MudText>

                @if (_residentEligibility.IsEligible)
                {
                    <MudAlert Severity="Severity.Success">
                        <MudText Typo="Typo.body2">
                            <strong>You are eligible!</strong> You have completed @_residentEligibility.YearsCompleted years.
                        </MudText>
                    </MudAlert>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               OnClick="SubmitResidentApplication"
                               Disabled="@(_submitting || _loading)">
                        @if (_submitting)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Submitting...</MudText>
                        }
                        else
                        {
                            <MudText>Apply for Resident Status</MudText>
                        }
                    </MudButton>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning">
                        <MudText Typo="Typo.body2">
                            <strong>Not yet eligible:</strong> @_residentEligibility.ReasonNotEligible
                        </MudText>
                    </MudAlert>
                }
            </MudStack>
        </MudPaper>
    }

    @if (_citizenEligibility is not null)
    {
        <MudPaper Class="pa-4">
            <MudStack Spacing="3">
                <div>
                    <MudText Typo="Typo.h6">Apply for Citizen Status</MudText>
                    <MudDivider Class="my-2" />
                </div>

                <MudText Typo="Typo.body2">
                    <strong>Requirements:</strong> Complete 5 total years (2 Probationary + 3 Resident)
                </MudText>

                @if (_citizenEligibility.IsEligible)
                {
                    <MudAlert Severity="Severity.Success">
                        <MudText Typo="Typo.body2">
                            <strong>You are eligible!</strong> You have completed @_citizenEligibility.YearsCompleted years.
                        </MudText>
                    </MudAlert>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               OnClick="SubmitCitizenApplication"
                               Disabled="@(_submitting || _loading)">
                        @if (_submitting)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Submitting...</MudText>
                        }
                        else
                        {
                            <MudText>Apply for Citizen Status</MudText>
                        }
                    </MudButton>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning">
                        <MudText Typo="Typo.body2">
                            <strong>Not yet eligible:</strong> @_citizenEligibility.ReasonNotEligible
                        </MudText>
                    </MudAlert>
                }
            </MudStack>
        </MudPaper>
    }

    @if (_progressionApplications.Count > 0)
    {
        <MudPaper Class="pa-4">
            <MudStack Spacing="3">
                <div>
                    <MudText Typo="Typo.h6">My Progression Applications</MudText>
                    <MudDivider Class="my-2" />
                </div>

                <MudSimpleTable>
                    <thead>
                        <tr>
                            <th>Application Number</th>
                            <th>Target Status</th>
                            <th>Status</th>
                            <th>Years at Application</th>
                            <th>Submitted</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var app in _progressionApplications)
                        {
                            <tr>
                                <td>@app.ApplicationNumber</td>
                                <td>@app.TargetStatus</td>
                                <td>
                                    <MudChip T="string" Size="Size.Small" Color="@GetApplicationStatusColor(app.Status)">
                                        @app.Status
                                    </MudChip>
                                </td>
                                <td>@app.YearsCompletedAtApplication years</td>
                                <td>@app.CreatedAt.LocalDateTime.ToString("yyyy-MM-dd")</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            </MudStack>
        </MudPaper>
    }

    @if (_timeline is not null && _timeline.Entries.Count > 0)
    {
        <MudPaper Class="pa-4">
            <MudStack Spacing="3">
                <div>
                    <MudText Typo="Typo.h6">Status Progression Timeline</MudText>
                    <MudDivider Class="my-2" />
                </div>

                <MudTimeline>
                    @foreach (var entry in _timeline.Entries.OrderBy(e => e.Timestamp))
                    {
                        <MudTimelineItem Size="Size.Medium">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body1"><strong>@entry.Event</strong></MudText>
                                <MudText Typo="Typo.body2">@entry.Description</MudText>
                                @if (!string.IsNullOrWhiteSpace(entry.Details))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@entry.Details</MudText>
                                }
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(entry.Status)" Class="mt-1">
                                    @entry.Status
                                </MudChip>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                                    @entry.Timestamp.LocalDateTime.ToString("yyyy-MM-dd HH:mm")
                                </MudText>
                            </MudStack>
                        </MudTimelineItem>
                    }
                </MudTimeline>
            </MudStack>
        </MudPaper>
    }
</MudStack>

@code
{
    private bool _loading = true;
    private StatusProgressionTimelineDto? _timeline;
    private bool _submitting = false;
    private string? _error;
    private StatusProgressionEligibilityDto? _residentEligibility;
    private StatusProgressionEligibilityDto? _citizenEligibility;
    private List<StatusProgressionApplicationDto> _progressionApplications = new();
    private CurrentStatusInfo? _currentStatus;

    private record CurrentStatusInfo(string Status, int YearsCompleted, DateTimeOffset? StatusExpiresAt);

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _loading = true;
            _error = null;

            var email = UserContext.UserName;
            if (string.IsNullOrWhiteSpace(email))
            {
                _error = "Unable to determine your email address.";
                return;
            }

            // Load current status
            var statusDetails = await StatusService.GetStatusDetailsAsync(email);
            if (statusDetails is not null)
            {
                _currentStatus = new CurrentStatusInfo(
                    statusDetails.Status.ToString(),
                    statusDetails.YearsCompleted,
                    statusDetails.StatusExpiresAt
                );
            }

            // Check eligibility for progression
            _residentEligibility = await ProgressionService.CheckEligibilityAsync(email, CitizenshipStatus.Resident);
            _citizenEligibility = await ProgressionService.CheckEligibilityAsync(email, CitizenshipStatus.Citizen);

            _progressionApplications = (await ProgressionService.GetProgressionApplicationsAsync(email)).ToList();

            // Load timeline
            _timeline = await ProgressionService.GetStatusProgressionTimelineAsync(email);
        }
        catch (Exception ex)
        {
            _error = $"Error loading data: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SubmitResidentApplication()
    {
        await SubmitProgressionApplication(CitizenshipStatus.Resident);
    }

    private async Task SubmitCitizenApplication()
    {
        await SubmitProgressionApplication(CitizenshipStatus.Citizen);
    }

    private async Task SubmitProgressionApplication(CitizenshipStatus targetStatus)
    {
        try
        {
            _submitting = true;
            _error = null;

            var email = UserContext.UserName;
            if (string.IsNullOrWhiteSpace(email))
            {
                _error = "Unable to determine your email address.";
                return;
            }

            var appNumber = await ProgressionService.SubmitProgressionApplicationAsync(email, targetStatus);
            
            // Reload data to show the new application
            await LoadDataAsync();
            
            // Show success message (could use Snackbar here)
            _error = null; // Clear any previous errors
        }
        catch (Exception ex)
        {
            _error = $"Error submitting application: {ex.Message}";
        }
        finally
        {
            _submitting = false;
        }
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Probationary" => Color.Warning,
            "Resident" => Color.Info,
            "Citizen" => Color.Success,
            _ => Color.Default
        };
    }

    private Color GetApplicationStatusColor(string status)
    {
        return status switch
        {
            "Submitted" => Color.Info,
            "Approved" => Color.Success,
            "Rejected" => Color.Error,
            _ => Color.Default
        };
    }
}

