@page "/library"
@using Mamey.Portal.Library.Application.Models
@using Mamey.Portal.Library.Application.Services
@inject ILibraryService LibraryService

<PageTitle>Library</PageTitle>

@code {
    private IReadOnlyList<LibraryItem> _items = Array.Empty<LibraryItem>();
    private string? _error;
    private string? _searchTerm;
    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        _error = null;
        try
        {
            _items = await LibraryService.GetPublishedPublicAsync(_searchTerm);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ClearSearchAsync()
    {
        _searchTerm = null;
        await LoadAsync();
    }
}

<MudStack Spacing="3">
    <MudText Typo="Typo.h4">Library</MudText>
    <MudText Typo="Typo.body1">
        Tenant-scoped library. Public items are available without login; citizen/government items appear inside their portals.
    </MudText>

    <MudPaper Class="pa-4">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="_searchTerm" Label="Search" Variant="Variant.Outlined" Immediate="true" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@_loading" OnClick="LoadAsync">Search</MudButton>
            <MudButton Variant="Variant.Text" Disabled="@_loading" OnClick="ClearSearchAsync">Clear</MudButton>
        </MudStack>
    </MudPaper>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }

    @if (_items.Count == 0)
    {
        <MudAlert Severity="Severity.Info">
            No published public library items yet.
        </MudAlert>
    }
    else
    {
        <MudTable Items="_items" Dense="true" Hover="true">
        <HeaderContent>
            <MudTh>Category</MudTh>
            <MudTh>Title</MudTh>
            <MudTh>Type</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Category">@context.Category</MudTd>
            <MudTd DataLabel="Title">
                <MudText Typo="Typo.body2">@context.Title</MudText>
                @if (!string.IsNullOrWhiteSpace(context.Summary))
                {
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.Summary</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Type">@context.ContentType</MudTd>
            <MudTd>
                <MudButton Size="Size.Small" Variant="Variant.Outlined" Href="@($"/library/files/{context.Id}")">
                    Download
                </MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
    }
</MudStack>

