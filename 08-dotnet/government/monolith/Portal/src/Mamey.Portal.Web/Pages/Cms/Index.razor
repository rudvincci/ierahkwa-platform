@page "/cms"
@using Mamey.Portal.Cms.Application.Models
@using Mamey.Portal.Cms.Application.Services
@using Mamey.Portal.Web.Components.Inputs
@attribute [Authorize(Roles = "ContentEditor,Admin")]
@inject ICmsContentService Cms
@inject ICmsPageService CmsPages
@inject Mamey.Portal.Shared.Auth.ICurrentUserContext CurrentUser
@inject MudBlazor.IDialogService Dialogs
@inject ICmsHtmlSanitizer HtmlSanitizer

<PageTitle>CMS</PageTitle>

@code {
    private string _newTitle = string.Empty;
    private string _newSummary = string.Empty;
    private string _newBodyHtml = "<p></p>";
    private bool _showPublicPreview;

    private IReadOnlyList<NewsItem> _news = Array.Empty<NewsItem>();
    private IReadOnlyList<PageItem> _pages = Array.Empty<PageItem>();
    private string? _error;
    private bool _busy;
    private Guid? _editingId;

    private string _pageSlug = string.Empty;
    private string _pageTitle = string.Empty;
    private string _pageBodyHtml = "<p></p>";
    private bool _showPagePublicPreview;
    private Guid? _editingPageId;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private bool IsAdmin => CurrentUser.IsInRole("Admin");

    private IReadOnlyList<NewsItem> ReviewQueue => _news.Where(x => x.Status == CmsContentStatus.InReview).ToList();
    private IReadOnlyList<NewsItem> MyDrafts => _news.Where(x => x.Status == CmsContentStatus.Draft || x.Status == CmsContentStatus.Rejected).ToList();
    private IReadOnlyList<PageItem> PageReviewQueue => _pages.Where(x => x.Status == CmsContentStatus.InReview).ToList();

    private async Task ReloadAsync()
    {
        _error = null;
        try
        {
            _news = await Cms.GetNewsAsync();
            _pages = await CmsPages.GetPagesAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task CreateAsync()
    {
        if (string.IsNullOrWhiteSpace(_newTitle) || string.IsNullOrWhiteSpace(_newSummary))
        {
            return;
        }

        _busy = true;
        _error = null;
        try
        {
            if (_editingId is Guid id)
            {
                await Cms.UpdateDraftAsync(id, _newTitle, _newSummary, _newBodyHtml);
                _editingId = null;
            }
            else
            {
                await Cms.CreateDraftAsync(_newTitle, _newSummary, _newBodyHtml);
            }
            _newTitle = string.Empty;
            _newSummary = string.Empty;
            _newBodyHtml = "<p></p>";
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private void StartEdit(NewsItem item)
    {
        if (item.Status != CmsContentStatus.Draft && item.Status != CmsContentStatus.Rejected)
        {
            return;
        }
        _editingId = item.Id;
        _newTitle = item.Title;
        _newSummary = item.Summary;
        _newBodyHtml = item.BodyHtml;
    }

    private void CancelEdit()
    {
        _editingId = null;
        _newTitle = string.Empty;
        _newSummary = string.Empty;
        _newBodyHtml = "<p></p>";
    }

    private MarkupString PublicPreviewMarkup()
        => new(HtmlSanitizer.SanitizeNewsBody(_newBodyHtml ?? string.Empty));

    private MarkupString PagePublicPreviewMarkup()
        => new(HtmlSanitizer.SanitizePageBody(_pageBodyHtml ?? string.Empty));

    private async Task CreateOrUpdatePageAsync()
    {
        if (string.IsNullOrWhiteSpace(_pageSlug) || string.IsNullOrWhiteSpace(_pageTitle))
        {
            return;
        }

        _busy = true;
        _error = null;
        try
        {
            if (_editingPageId is Guid id)
            {
                await CmsPages.UpdateDraftAsync(id, _pageSlug, _pageTitle, _pageBodyHtml);
                _editingPageId = null;
            }
            else
            {
                await CmsPages.CreateDraftAsync(_pageSlug, _pageTitle, _pageBodyHtml);
            }

            _pageSlug = string.Empty;
            _pageTitle = string.Empty;
            _pageBodyHtml = "<p></p>";
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private void StartEditPage(PageItem item)
    {
        if (item.Status != CmsContentStatus.Draft
            && item.Status != CmsContentStatus.Rejected
            && item.Status != CmsContentStatus.Approved)
        {
            return;
        }

        _editingPageId = item.Id;
        _pageSlug = item.Slug;
        _pageTitle = item.Title;
        _pageBodyHtml = item.BodyHtml;
    }

    private void CancelEditPage()
    {
        _editingPageId = null;
        _pageSlug = string.Empty;
        _pageTitle = string.Empty;
        _pageBodyHtml = "<p></p>";
    }

    private async Task SubmitPageForReviewAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            await CmsPages.SubmitForReviewAsync(id);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task ApprovePageAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            await CmsPages.ApproveAsync(id);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task RejectPageAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            var item = _pages.FirstOrDefault(x => x.Id == id);
            var dialog = Dialogs.Show<PageRejectDialog>(
                "Reject Page",
                new DialogParameters { ["ItemTitle"] = $"{item?.Slug ?? "(unknown)"} — {item?.Title ?? "(untitled)"}" },
                new DialogOptions { CloseButton = true, MaxWidth = MudBlazor.MaxWidth.Small, FullWidth = true });

            var result = await dialog.Result;
            if (result.Canceled)
            {
                return;
            }

            var reason = result.Data as string ?? "Needs changes";
            await CmsPages.RejectAsync(id, reason);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task PublishPageAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            await CmsPages.PublishAsync(id);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task UnpublishPageAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            await CmsPages.UnpublishAsync(id);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task SubmitForReviewAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            await Cms.SubmitForReviewAsync(id);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task ApproveAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            await Cms.ApproveAsync(id);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task RejectAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            var item = _news.FirstOrDefault(x => x.Id == id);
            var dialog = Dialogs.Show<RejectDialog>(
                "Reject",
                new DialogParameters { ["ItemTitle"] = item?.Title ?? "(untitled)" },
                new DialogOptions { CloseButton = true, MaxWidth = MudBlazor.MaxWidth.Small, FullWidth = true });

            var result = await dialog.Result;
            if (result.Canceled)
            {
                return;
            }

            var reason = result.Data as string ?? "Needs changes";
            await Cms.RejectAsync(id, reason);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task PublishAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            await Cms.PublishAsync(id);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task UnpublishAsync(Guid id)
    {
        _busy = true;
        _error = null;
        try
        {
            await Cms.UnpublishAsync(id);
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }
}

<MudStack Spacing="3">
    <MudText Typo="Typo.h4">CMS</MudText>
    <MudText Typo="Typo.body1">
        Tenant-scoped CMS with a basic publishing workflow: Draft → InReview → Approved → Published.
    </MudText>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }

    <MudTabs>
        <MudTabPanel Text="News">
            <MudPaper Class="pa-4 mb-3">
                <MudText Typo="Typo.h6">@(_editingId is null ? "Create news item (Draft)" : "Edit news item (Draft)")</MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_newTitle" Label="Title" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_newSummary" Label="Summary" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-1">
                            <MudText Typo="Typo.subtitle2">Body (WYSIWYG)</MudText>
                            <MudSwitch T="bool" @bind-Checked="_showPublicPreview" Color="Color.Primary" Label="Public preview (sanitized)" />
                        </MudStack>
                        <WysiwygHtmlEditor @bind-Value="_newBodyHtml" MinHeight="220" />

                        @if (_showPublicPreview)
                        {
                            <MudPaper Class="pa-3 mt-3" Outlined="true">
                                <MudText Typo="Typo.subtitle2" GutterBottom="true">Public preview (sanitized)</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary" GutterBottom="true">
                                    This is the allowlist-sanitized HTML that will render on <code>/news</code>. Unsupported tags/attributes are removed.
                                </MudText>
                                <div class="cms-news-body">
                                    @PublicPreviewMarkup()
                                </div>
                            </MudPaper>
                        }
                    </MudItem>
                    <MudItem xs="12">
                        <MudStack Row="true" Spacing="1">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateAsync" Disabled="@_busy">
                                @(_editingId is null ? "Add" : "Save")
                            </MudButton>
                            @if (_editingId is not null)
                            {
                                <MudButton Variant="Variant.Text" OnClick="CancelEdit" Disabled="@_busy">Cancel</MudButton>
                            }
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudTable Items="_news" Dense="true" Hover="true">
                <HeaderContent>
                    <MudTh>Title</MudTh>
                    <MudTh>Created</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Title">
                        <MudText Typo="Typo.body2">@context.Title</MudText>
                        @if (context.Status == CmsContentStatus.Rejected && !string.IsNullOrWhiteSpace(context.RejectionReason))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Error">Rejected: @context.RejectionReason</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Created">@context.CreatedAt.LocalDateTime</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string"
                                 Variant="Variant.Outlined"
                                 Color="@(context.Status == CmsContentStatus.Published ? Color.Success :
                                         context.Status == CmsContentStatus.InReview ? Color.Info :
                                         context.Status == CmsContentStatus.Rejected ? Color.Error :
                                         context.Status == CmsContentStatus.Approved ? Color.Primary : Color.Default)">
                            @context.Status
                        </MudChip>
                    </MudTd>
                    <MudTd>
                        @if (context.Status == CmsContentStatus.Draft || context.Status == CmsContentStatus.Rejected)
                        {
                            <MudStack Row="true" Spacing="1">
                                <MudButton Size="Size.Small" Variant="Variant.Outlined" Disabled="@_busy" OnClick="@(() => StartEdit(context))">
                                    Edit
                                </MudButton>
                                <MudButton Size="Size.Small" Variant="Variant.Outlined" Disabled="@_busy" OnClick="@(() => SubmitForReviewAsync(context.Id))">
                                    Submit for review
                                </MudButton>
                            </MudStack>
                        }
                        else if (context.Status == CmsContentStatus.InReview && IsAdmin)
                        {
                            <MudStack Row="true" Spacing="1">
                                <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Success" Disabled="@_busy" OnClick="@(() => ApproveAsync(context.Id))">
                                    Approve
                                </MudButton>
                                <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error" Disabled="@_busy" OnClick="@(() => RejectAsync(context.Id))">
                                    Reject
                                </MudButton>
                            </MudStack>
                        }
                        else if (context.Status == CmsContentStatus.Approved && IsAdmin)
                        {
                            <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary" Disabled="@_busy" OnClick="@(() => PublishAsync(context.Id))">
                                Publish
                            </MudButton>
                        }
                        else if (context.Status == CmsContentStatus.Published && IsAdmin)
                        {
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Warning" Disabled="@_busy" OnClick="@(() => UnpublishAsync(context.Id))">
                                Unpublish
                            </MudButton>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>

        @if (IsAdmin)
        {
            <MudTabPanel Text="Review Queue">
                <MudText Typo="Typo.body2" Class="mud-text-secondary" GutterBottom="true">
                    Items awaiting approval (InReview).
                </MudText>

                @if (ReviewQueue.Count == 0)
                {
                    <MudAlert Severity="Severity.Info">No items in review.</MudAlert>
                }
                else
                {
                    <MudTable Items="ReviewQueue" Dense="true" Hover="true">
                        <HeaderContent>
                            <MudTh>Title</MudTh>
                            <MudTh>Submitted</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Title">@context.Title</MudTd>
                            <MudTd DataLabel="Submitted">@((context.SubmittedAt ?? context.UpdatedAt).LocalDateTime)</MudTd>
                            <MudTd>
                                <MudStack Row="true" Spacing="1">
                                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Success" Disabled="@_busy" OnClick="@(() => ApproveAsync(context.Id))">
                                        Approve
                                    </MudButton>
                                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error" Disabled="@_busy" OnClick="@(() => RejectAsync(context.Id))">
                                        Reject
                                    </MudButton>
                                </MudStack>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudTabPanel>
        }

        <MudTabPanel Text="Recognitions">
            <MudAlert Severity="Severity.Info">
                Placeholder: recognitions management will live here (mock first, then persisted per tenant).
            </MudAlert>
        </MudTabPanel>

        <MudTabPanel Text="Pages">
            <MudPaper Class="pa-4 mb-3">
                <MudText Typo="Typo.h6">@(_editingPageId is null ? "Create page (Draft)" : "Edit page (Draft)")</MudText>
                <MudText Typo="Typo.caption" Class="mud-text-secondary" GutterBottom="true">
                    Pages are addressed by <b>slug</b> (example: <code>about-us</code>). Public pages render only Published items.
                </MudText>

                <MudGrid Spacing="2">
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="_pageSlug" Label="Slug" Variant="Variant.Outlined" Placeholder="about-us" />
                    </MudItem>
                    <MudItem xs="12" md="8">
                        <MudTextField @bind-Value="_pageTitle" Label="Title" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-1">
                            <MudText Typo="Typo.subtitle2">Body (WYSIWYG)</MudText>
                            <MudSwitch T="bool" @bind-Checked="_showPagePublicPreview" Color="Color.Primary" Label="Public preview (sanitized)" />
                        </MudStack>
                        <WysiwygHtmlEditor @bind-Value="_pageBodyHtml" MinHeight="260" />

                        @if (_showPagePublicPreview)
                        {
                            <MudPaper Class="pa-3 mt-3" Outlined="true">
                                <MudText Typo="Typo.subtitle2" GutterBottom="true">Public preview (sanitized)</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary" GutterBottom="true">
                                    This is the allowlist-sanitized HTML that renders on public pages. Unsupported tags/attributes are removed.
                                </MudText>
                                <div class="cms-news-body">
                                    @PagePublicPreviewMarkup()
                                </div>
                            </MudPaper>
                        }
                    </MudItem>
                    <MudItem xs="12">
                        <MudStack Row="true" Spacing="1">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateOrUpdatePageAsync" Disabled="@_busy">
                                @(_editingPageId is null ? "Add" : "Save")
                            </MudButton>
                            @if (_editingPageId is not null)
                            {
                                <MudButton Variant="Variant.Text" OnClick="CancelEditPage" Disabled="@_busy">Cancel</MudButton>
                            }
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @if (_pages.Count == 0)
            {
                <MudAlert Severity="Severity.Info">No pages yet.</MudAlert>
            }
            else
            {
                <MudTable Items="_pages" Dense="true" Hover="true">
                    <HeaderContent>
                        <MudTh>Slug</MudTh>
                        <MudTh>Title</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Updated</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Slug">@context.Slug</MudTd>
                        <MudTd DataLabel="Title">
                            <MudText Typo="Typo.body2">@context.Title</MudText>
                            @if (context.Status == CmsContentStatus.Rejected && !string.IsNullOrWhiteSpace(context.RejectionReason))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Error">Rejected: @context.RejectionReason</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string"
                                     Variant="Variant.Outlined"
                                     Color="@(context.Status == CmsContentStatus.Published ? Color.Success :
                                             context.Status == CmsContentStatus.InReview ? Color.Info :
                                             context.Status == CmsContentStatus.Rejected ? Color.Error :
                                             context.Status == CmsContentStatus.Approved ? Color.Primary : Color.Default)">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Updated">@context.UpdatedAt.LocalDateTime</MudTd>
                        <MudTd>
                            @if (context.Status == CmsContentStatus.Draft || context.Status == CmsContentStatus.Rejected)
                            {
                                <MudStack Row="true" Spacing="1">
                                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Disabled="@_busy" OnClick="@(() => StartEditPage(context))">
                                        Edit
                                    </MudButton>
                                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Disabled="@_busy" OnClick="@(() => SubmitPageForReviewAsync(context.Id))">
                                        Submit for review
                                    </MudButton>
                                </MudStack>
                            }
                            else if (context.Status == CmsContentStatus.InReview && IsAdmin)
                            {
                                <MudStack Row="true" Spacing="1">
                                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Success" Disabled="@_busy" OnClick="@(() => ApprovePageAsync(context.Id))">
                                        Approve
                                    </MudButton>
                                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error" Disabled="@_busy" OnClick="@(() => RejectPageAsync(context.Id))">
                                        Reject
                                    </MudButton>
                                </MudStack>
                            }
                        else if (context.Status == CmsContentStatus.Approved && IsAdmin)
                        {
                            <MudStack Row="true" Spacing="1">
                                <MudButton Size="Size.Small" Variant="Variant.Outlined" Disabled="@_busy" OnClick="@(() => StartEditPage(context))">
                                    Edit
                                </MudButton>
                                <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary" Disabled="@_busy" OnClick="@(() => PublishPageAsync(context.Id))">
                                    Publish
                                </MudButton>
                            </MudStack>
                        }
                            else if (context.Status == CmsContentStatus.Published && IsAdmin)
                            {
                                <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Warning" Disabled="@_busy" OnClick="@(() => UnpublishPageAsync(context.Id))">
                                    Unpublish
                                </MudButton>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudTabPanel>
    </MudTabs>
</MudStack>

