@inject IJSRuntime JSRuntime

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Preview" Class="mr-2" />
            @Title
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudPaper Class="pa-4 mb-4" Style="min-height: 400px; max-height: 600px; overflow-y: auto;">
            @if (IsLoading)
            {
                <div class="d-flex justify-center align-center" style="height: 300px;">
                    <MudProgressCircular Indeterminate="true" />
                </div>
            }
            else if (!string.IsNullOrEmpty(HtmlContent))
            {
                @((MarkupString)HtmlContent)
            }
            else if (!string.IsNullOrEmpty(PdfUrl))
            {
                <embed src="@PdfUrl" type="application/pdf" width="100%" height="500px" />
            }
            else if (ImageBytes != null)
            {
                <img src="@($"data:image/png;base64,{Convert.ToBase64String(ImageBytes)}")" 
                     alt="Preview" style="max-width: 100%; height: auto;" />
            }
            else
            {
                <MudAlert Severity="Severity.Info">No preview available</MudAlert>
            }
        </MudPaper>
        
        @if (!string.IsNullOrEmpty(Description))
        {
            <MudText Typo="Typo.body2" Color="Color.Default">@Description</MudText>
        }
    </DialogContent>
    <DialogActions>
        @if (!string.IsNullOrEmpty(DownloadUrl) || DownloadBytes != null)
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="Download">
                Download
            </MudButton>
        }
        @if (!string.IsNullOrEmpty(PrintUrl))
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.Print"
                       OnClick="Print">
                Print
            </MudButton>
        }
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public string Title { get; set; } = "Document Preview";
    [Parameter] public string? Description { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    
    // Content options (only one should be set)
    [Parameter] public string? HtmlContent { get; set; }
    [Parameter] public string? PdfUrl { get; set; }
    [Parameter] public byte[]? ImageBytes { get; set; }
    
    // Download/Print options
    [Parameter] public string? DownloadUrl { get; set; }
    [Parameter] public byte[]? DownloadBytes { get; set; }
    [Parameter] public string? DownloadFileName { get; set; }
    [Parameter] public string? PrintUrl { get; set; }

    private void Close() => MudDialog.Close();

    private async Task Download()
    {
        if (DownloadBytes != null)
        {
            var base64 = Convert.ToBase64String(DownloadBytes);
            var fileName = DownloadFileName ?? "document.pdf";
            await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", base64, fileName);
        }
        else if (!string.IsNullOrEmpty(DownloadUrl))
        {
            await JSRuntime.InvokeVoidAsync("downloadFile", DownloadUrl, DownloadFileName ?? "document");
        }
    }

    private async Task Print()
    {
        if (!string.IsNullOrEmpty(PrintUrl))
        {
            await JSRuntime.InvokeVoidAsync("printDocument", PrintUrl);
        }
    }
}
