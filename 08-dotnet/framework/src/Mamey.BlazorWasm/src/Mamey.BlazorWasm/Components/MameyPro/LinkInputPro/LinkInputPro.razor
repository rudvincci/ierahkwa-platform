@using Mamey.Types
@using Mamey.BlazorWasm.Components.Foundation

<MudPaper Class="@PaperClass" Style="@Style">
    <MudGrid>
        <MudItem xs="12">
            <MudTextField T="string"
                         Label="URL"
                         Placeholder="@UrlPlaceholder"
                         @bind-Value="_url"
                         Immediate="true"
                         OnBlur="@(() => Validate())"
                         Required="@Required"
                         Disabled="@Disabled"
                         Variant="@Variant"
                         Error="_error"
                         ErrorText="@_errorText"
                         Class="@Class" />
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudTextField T="string"
                         Label="Href"
                         Placeholder="@HrefPlaceholder"
                         @bind-Value="_href"
                         Immediate="true"
                         OnBlur="@(() => Validate())"
                         Disabled="@Disabled"
                         Variant="@Variant" />
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudTextField T="string"
                         Label="Method"
                         Placeholder="@MethodPlaceholder"
                         @bind-Value="_method"
                         Immediate="true"
                         OnBlur="@(() => Validate())"
                         Disabled="@Disabled"
                         Variant="@Variant" />
        </MudItem>
    </MudGrid>
    <FieldMessages HelperText="@HelperText" />
</MudPaper>

@code {
    [Parameter] public string Label { get; set; } = "Link";
    [Parameter] public string HelperText { get; set; } = "Enter link information";
    [Parameter] public string UrlPlaceholder { get; set; } = "https://example.com";
    [Parameter] public string HrefPlaceholder { get; set; } = "/path/to/resource";
    [Parameter] public string MethodPlaceholder { get; set; } = "GET";
    [Parameter] public bool Required { get; set; } = false;
    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public Variant Variant { get; set; } = Variant.Text;
    [Parameter] public string Class { get; set; } = "";
    [Parameter] public string Style { get; set; } = "";

    [Parameter] public Link? Value { get; set; }
    [Parameter] public EventCallback<Link?> ValueChanged { get; set; }

    private string _url = "";
    private string _href = "";
    private string _method = "";
    private bool _error = false;
    private string _errorText = "";

    protected override void OnParametersSet()
    {
        if (Value is not null)
        {
            _url = Value.Url ?? "";
            _href = Value.Href ?? "";
            _method = Value.Method ?? "";
        }
    }

    private async Task Validate()
    {
        _error = false;
        _errorText = "";

        if (Required && string.IsNullOrWhiteSpace(_url))
        {
            _error = true;
            _errorText = "URL is required.";
            await ValueChanged.InvokeAsync(null);
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(_url) && string.IsNullOrWhiteSpace(_href))
        {
            await ValueChanged.InvokeAsync(null);
            StateHasChanged();
            return;
        }

        try
        {
            var link = new Link
            {
                Url = _url,
                Href = _href,
                Method = _method
            };
            await ValueChanged.InvokeAsync(link);
        }
        catch (Exception ex)
        {
            _error = true;
            _errorText = ex.Message;
            await ValueChanged.InvokeAsync(null);
        }
        StateHasChanged();
    }

    private string PaperClass => $"pa-4 {Class}";
}




