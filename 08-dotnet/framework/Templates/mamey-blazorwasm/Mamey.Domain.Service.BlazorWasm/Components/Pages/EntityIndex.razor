@page "/service"
@page "/service/index"
@using Mamey.Domain.Service.Contracts
@inject IServiceService Service
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Service</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Service</MudText>
    
    <MudButton Variant="Variant.Filled" 
               Color="Color.Primary" 
               StartIcon="@Icons.Material.Filled.Add"
               Href="/service/create"
               Class="mb-4">
        Create New
    </MudButton>
    
    @if (_entities == null)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (_entities.Items.Any())
    {
        <MameyDataGridPro Items="@_entities.Items"
                          TItem="EntitySummaryDto"
                          OnRowClick="OnRowClick"
                          PageSize="10"
                          Dense="true"
                          Hover="true"
                          Striped="true">
            <Columns>
                <PropertyColumn Property="@(x => x.Id)" Title="ID" />
                <PropertyColumn Property="@(x => x.Name)" Title="Name" />
                <TemplateColumn Title="Actions">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Color="Color.Primary"
                                       OnClick="@(() => Navigation.NavigateTo($"/service/{context.Id}/edit"))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error"
                                       OnClick="@(() => OnDelete(context.Id))" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MameyDataGridPro>
        
        <MudPagination Count="@_entities.TotalCount" 
                       Selected="@_currentPage" 
                       SelectedChanged="@OnPageChanged"
                       BoundaryCount="2"
                       Class="mt-4" />
    }
    else
    {
        <MudAlert Severity="Severity.Info">No entities found.</MudAlert>
    }
</MudContainer>

@code {
    private PagedResult<EntitySummaryDto>? _entities;
    private int _currentPage = 1;
    private const int PageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntitiesAsync();
    }

    private async Task LoadEntitiesAsync()
    {
        var query = new GetEntitiesQuery
        {
            PageNumber = _currentPage,
            PageSize = PageSize
        };
        
        _entities = await Service.GetAsync(query);
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadEntitiesAsync();
    }

    private void OnRowClick(EntitySummaryDto item)
    {
        Navigation.NavigateTo($"/service/{item.Id}");
    }

    private async Task OnDelete(Guid id)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this entity?",
            yesText: "Delete", cancelText: "Cancel");
        
        if (confirmed == true)
        {
            await Service.DeleteAsync(id);
            await LoadEntitiesAsync();
        }
    }
}

