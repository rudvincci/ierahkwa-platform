version: '3.7'

services:
  consul:
    image: hashicorp/consul
    container_name: consul
    restart: unless-stopped
    networks:
      - mamey
    ports:
      - 8500:8500
    volumes:
      - consul:/consul/data
  fabio:
    image: fabiolb/fabio
    container_name: fabio
    restart: unless-stopped
    environment:
    - FABIO_REGISTRY_CONSUL_ADDR=consul:8500
    networks:
      - mamey
    ports:
    - 9998:9998
    - 9999:9999

  grafana:
    image: grafana/grafana
    container_name: grafana
    restart: unless-stopped
    networks:
      - mamey
    ports:
      - 3000:3000
    volumes:
      - grafana:/var/lib/grafana

  jaeger:
    image: jaegertracing/all-in-one
    container_name: jaeger
    restart: unless-stopped
    networks:
      - mamey
    ports:
      - 5778:5778
      - 9411:9411
      - 14268:14268
      - 16686:16686
      - 5775:5775/udp
      - 6831:6831/udp
      - 6832:6832/udp

  mongo:
    image: mongo
    container_name: mongo
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    networks:
      - mamey
    ports:
      - 27017:27017
    volumes:
      - mongo:/data/db

  prometheus:
    build: ./prometheus
    container_name: prometheus
    restart: unless-stopped
    networks:
      - futurebdet
      - futureheadgroup
    ports:
      - 9090:9090
    volumes:
      - prometheus:/prometheus
  postgres:
    image: postgres
    restart: unless-stopped
    # set shared memory limit when using docker-compose
    shm_size: 128mb
    #volumes:
    #  - type: tmpfs
    #    target: /dev/shm
    #    tmpfs:
    #      size: 134217728 # 128*2^20 bytes = 128Mb
    environment:
      # This environment variable is required for you to use the PostgreSQL image. 
      # It must not be empty or undefined. This environment variable sets the superuser 
      # password for PostgreSQL. The default superuser is defined by the POSTGRES_USER 
      # environment variable.
      POSTGRES_PASSWORD: secret
      # This optional environment variable is used in conjunction with POSTGRES_PASSWORD 
      # to set a user and its password. This variable will create the specified user with 
      # superuser power and a database with the same name. If it is not specified, then 
      # the default user of postgres will be used.
      POSTGRES_USER: admin
      # This optional environment variable can be used to define a 
      # different name for the default database that is created when 
      # the image is first started. If it is not specified, then the 
      # value of POSTGRES_USER will be used.
      POSTGRES_DB: postgres

      # This optional environment variable can be used to send arguments to postgres initdb. 
      # The value is a space separated string of arguments as postgres initdb would expect them. 
      # This is useful for adding functionality like data page checksums: -e POSTGRES_INITDB_ARGS="--data-checksums".
      # POSTGRES_INITDB_ARGS: 
      
      # This optional environment variable can be used to define another location for the 
      # Postgres transaction log. By default the transaction log is stored in a subdirectory 
      # of the main Postgres data folder (PGDATA)
      # POSTGRES_INITDB_WALDIR: 

      # This optional variable can be used to control the auth-method for host connections for all databases, 
      # all users, and all addresses. If unspecified then scram-sha-256 password authentication‚Å† is used (in 14+; md5 in older releases)
      # POSTGRES_HOST_AUTH_METHOD: 

      # This optional variable can be used to define another location - like a subdirectory - for the database files. 
      # The default is /var/lib/postgresql/data
      # PGDATA:
    ports:
      - 5432:5432 
    networks:
      - mamey

  rabbitmq:
    build: ./rabbitmq
    container_name: rabbitmq
    restart: unless-stopped
    networks:
      - futurebdet
      - futureheadgroup
    ports:
      - 5672:5672
      - 15672:15672
      - 15692:15692
    volumes: 
      - rabbitmq:/var/lib/rabbitmq

  redis:
    image: redis
    container_name: redis
    restart: unless-stopped
    networks:
      - mamey
    ports:
      - 6379:6379
    volumes: 
      - redis:/data

  seq:
    image: datalust/seq 
    container_name: seq
    restart: unless-stopped
    environment:
      - ACCEPT_EULA=Y
    networks:
      - mamey
    ports:
      - 5341:80
    volumes: 
      - seq:/data

  vault:
    image: vault
    container_name: hashicorp/vault
    restart: unless-stopped
    environment:
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_ROOT_TOKEN}
    cap_add:
      - IPC_LOCK
    networks:
      - mamey
    ports:
      - 8200:8200

networks:
  mamey:
    name: mamey
    external: true

volumes:
  consul:
    driver: local
  grafana:
    driver: local
  mongo:
    driver: local
  prometheus:
    driver: local
  rabbitmq:
    driver: local
  redis:
    driver: local
  seq:
    driver: local