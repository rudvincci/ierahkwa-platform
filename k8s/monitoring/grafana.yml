apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: ierahkwa
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus:9090
        isDefault: true
        access: proxy
      - name: Elasticsearch
        type: elasticsearch
        url: http://elasticsearch:9200
        access: proxy
        database: "ierahkwa-logs-*"
        jsonData:
          timeField: "@timestamp"
          esVersion: "8.0.0"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-config
  namespace: ierahkwa
data:
  dashboards.yml: |
    apiVersion: 1
    providers:
      - name: default
        folder: Ierahkwa
        type: file
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: ierahkwa
data:
  platform-overview.json: |
    {
      "dashboard": {
        "title": "Ierahkwa Platform Overview",
        "uid": "ierahkwa-overview",
        "panels": [
          {
            "title": "Services Up", "type": "stat", "gridPos": {"h":4,"w":6,"x":0,"y":0},
            "targets": [{"expr": "count(up{job=~'.*service'} == 1)"}]
          },
          {
            "title": "Total Requests/s", "type": "stat", "gridPos": {"h":4,"w":6,"x":6,"y":0},
            "targets": [{"expr": "sum(rate(http_requests_total[5m]))"}]
          },
          {
            "title": "Error Rate", "type": "stat", "gridPos": {"h":4,"w":6,"x":12,"y":0},
            "targets": [{"expr": "sum(rate(http_requests_total{status=~'5..'}[5m])) / sum(rate(http_requests_total[5m])) * 100"}]
          },
          {
            "title": "P95 Latency", "type": "stat", "gridPos": {"h":4,"w":6,"x":18,"y":0},
            "targets": [{"expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))"}]
          },
          {
            "title": "Requests by NEXUS Domain", "type": "timeseries", "gridPos": {"h":8,"w":12,"x":0,"y":4},
            "targets": [{"expr": "sum(rate(http_requests_total[5m])) by (job)", "legendFormat": "{{job}}"}]
          },
          {
            "title": "Active Tenants", "type": "timeseries", "gridPos": {"h":8,"w":12,"x":12,"y":4},
            "targets": [{"expr": "count(count by (tenant) (http_requests_total))", "legendFormat": "Active Tenants"}]
          },
          {
            "title": "Memory by Service", "type": "timeseries", "gridPos": {"h":8,"w":12,"x":0,"y":12},
            "targets": [{"expr": "container_memory_usage_bytes{namespace='ierahkwa'} / 1024 / 1024", "legendFormat": "{{pod}}"}]
          },
          {
            "title": "CPU by Service", "type": "timeseries", "gridPos": {"h":8,"w":12,"x":12,"y":12},
            "targets": [{"expr": "rate(container_cpu_usage_seconds_total{namespace='ierahkwa'}[5m]) * 100", "legendFormat": "{{pod}}"}]
          }
        ]
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: ierahkwa
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:10.3.0
          ports:
            - containerPort: 3000
          env:
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ierahkwa-production-secrets
                  key: grafana-password
            - name: GF_SERVER_ROOT_URL
              value: https://monitor.ierahkwa.org
          volumeMounts:
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: dashboards-config
              mountPath: /etc/grafana/provisioning/dashboards
            - name: dashboards
              mountPath: /var/lib/grafana/dashboards
            - name: data
              mountPath: /var/lib/grafana
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "250m"
      volumes:
        - name: datasources
          configMap:
            name: grafana-datasources
        - name: dashboards-config
          configMap:
            name: grafana-dashboards-config
        - name: dashboards
          configMap:
            name: grafana-dashboards
        - name: data
          persistentVolumeClaim:
            claimName: grafana-data
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: ierahkwa
spec:
  selector:
    app: grafana
  ports:
    - port: 3000
      targetPort: 3000
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-data
  namespace: ierahkwa
spec:
  accessModes: [ReadWriteOnce]
  resources:
    requests:
      storage: 10Gi
