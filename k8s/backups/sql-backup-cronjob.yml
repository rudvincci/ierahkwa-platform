apiVersion: batch/v1
kind: CronJob
metadata:
  name: sqlserver-backup
  namespace: ierahkwa
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM UTC
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backupLimit: 1
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: mcr.microsoft.com/mssql-tools18:latest
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_DIR="/backups"
                  DB_NAME="IerahkwaDb"
                  BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_${TIMESTAMP}.bak"

                  echo "=== Ierahkwa SQL Backup â€” ${TIMESTAMP} ==="

                  # Full backup
                  /opt/mssql-tools18/bin/sqlcmd \
                    -S sqlserver -U sa -P "${SQL_PASSWORD}" -C -No \
                    -Q "BACKUP DATABASE [${DB_NAME}] TO DISK='${BACKUP_FILE}' WITH COMPRESSION, STATS=10"

                  echo "Backup created: ${BACKUP_FILE}"
                  ls -lh "${BACKUP_FILE}"

                  # Cleanup backups older than 30 days
                  find "${BACKUP_DIR}" -name "*.bak" -mtime +30 -delete
                  echo "Old backups cleaned up"

                  # Upload to S3-compatible storage
                  if [ -n "${S3_BUCKET}" ]; then
                    aws s3 cp "${BACKUP_FILE}" "s3://${S3_BUCKET}/sql-backups/${DB_NAME}_${TIMESTAMP}.bak"
                    echo "Uploaded to S3: s3://${S3_BUCKET}/sql-backups/"
                  fi

                  echo "=== Backup Complete ==="
              env:
                - name: SQL_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: ierahkwa-production-secrets
                      key: sql-password
                - name: S3_BUCKET
                  value: "ierahkwa-backups"
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: sql-backup-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sql-backup-pvc
  namespace: ierahkwa
spec:
  accessModes: [ReadWriteOnce]
  resources:
    requests:
      storage: 200Gi
---
# Weekly full backup (Sundays at 1 AM)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: sqlserver-backup-weekly
  namespace: ierahkwa
spec:
  schedule: "0 1 * * 0"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: mcr.microsoft.com/mssql-tools18:latest
              command:
                - /bin/bash
                - -c
                - |
                  TIMESTAMP=$(date +%Y%m%d)
                  /opt/mssql-tools18/bin/sqlcmd \
                    -S sqlserver -U sa -P "${SQL_PASSWORD}" -C -No \
                    -Q "BACKUP DATABASE [IerahkwaDb] TO DISK='/backups/IerahkwaDb_WEEKLY_${TIMESTAMP}.bak' WITH COMPRESSION, COPY_ONLY"
                  echo "Weekly full backup complete: ${TIMESTAMP}"
              env:
                - name: SQL_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: ierahkwa-production-secrets
                      key: sql-password
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: sql-backup-pvc
